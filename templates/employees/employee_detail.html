{% extends 'base.html' %}

{% block title %}{{ employee.full_name }} - Employee Details{% endblock %}

{% block page_title %}Employee Profile{% endblock %}

{% block extra_css %}
<style>
    .profile-header-card {
        background: linear-gradient(135deg, #332666 0%, #332666 100%);
        color: white;
        border-radius: 16px;
        padding: 40px;
        margin-bottom: 24px;
        text-align: center;
    }

    .profile-avatar-large {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        background: #e50880;
        color: #002855;

        background: linear-gradient(135deg, #332666 0%, #332666 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 48px;
        font-weight: 800;
        margin: 0 auto 24px;

        box-shadow: 0 12px 32px rgba(229, 8, 128, 0.4);
        box-shadow: 0 12px 32px rgba(0, 201, 255, 0.4);
        position: relative;
        overflow: hidden;
        border: 3px solid rgba(255, 255, 255, 0.2);
    }

    .profile-avatar-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 50%;
        transition: all 0.3s_ease;
    }

    .profile-avatar-large .avatar-fallback {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #332666 0%, #332666 100%);
        color: white;
        font-size: 48px;
        font-weight: 800;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .profile-name {
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 8px;
        color: #fff;
    }

    .profile-designation {
        font-size: 16px;
        opacity: 0.9;
        margin-bottom: 20px;
    }

    .profile-badges {
        display: flex;
        gap: 12px;
        justify-content: center;
        flex-wrap: wrap;
        margin-bottom: 24px;
    }

    .profile-badge {
        padding: 8px 16px;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.2);
        font-size: 13px;
        font-weight: 600;
    }

    .profile-actions {
        display: flex;
        gap: 12px;
        justify-content: center;
    }

    .document-status-icon {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
    }

    .document-status-icon.success {
        background: #e6fcf5;
        color: #0ca678;
    }

    .document-status-icon.warning {
        background: #fff9db;
        color: #f08c00;
    }

    .bg-soft-info {
        background-color: rgba(13, 202, 240, 0.1);
    }

    .font-size-11 {
        font-size: 11px;
    }
</style>
{% endblock %}

{% block content %}
<!-- Profile Header -->
<div class="profile-header-card">
    <div class="profile-avatar-large">
        {% if employee.profile_picture %}
        <img src="{{ employee.profile_picture.url }}" alt="{{ employee.full_name }}" class="profile-avatar-img"
            onerror="this.style.display='none'; this.parentElement.querySelector('.avatar-fallback').style.display='flex';">
        {% else %}
        <div class="avatar-fallback">{{ employee.full_name|slice:":2"|upper }}</div>
        {% endif %}
    </div>
    <h1 class="profile-name">{{ employee.full_name }}</h1>
    <p class="profile-designation">{{ employee.designation.name }}</p>

    <div class="profile-badges">
        <span class="profile-badge">
            <i class="bi bi-hash"></i> {{ employee.employee_code }}
        </span>
        <span class="profile-badge">
            <i class="bi bi-building"></i> {{ employee.department.name }}
        </span>
        <span
            class="profile-badge {% if employee.employment_status == 'active' %}bg-success{% else %}bg-danger{% endif %}">
            <i
                class="bi bi-{% if employee.employment_status == 'active' %}check-circle{% else %}x-circle{% endif %}"></i>
            {{ employee.get_employment_status_display }}
        </span>
    </div>

    <div class="profile-actions">
        {% if request.user.is_superuser or request.user.is_staff %}
        <a href="{% url 'employees:employee_edit' employee.pk %}" class="btn btn-light">
            <i class="bi bi-pencil me-2"></i>Edit Profile
        </a>
        {% endif %}
        <a href="{% url 'employees:salary_details' employee.pk %}" class="btn btn-secondary">
            <i class="bi bi-cash-stack me-2"></i>Salary & PaySlips
        </a>
        <a href="{% url 'employees:employee_list' %}" class="btn btn-outline-light">
            <i class="bi bi-arrow-left me-2"></i>Back to List
        </a>
    </div>
</div>

<div class="row">
    <!-- Left Column -->
    <div class="col-lg-6">
        <!-- Contact Information -->
        <div class="detail-section">
            <h5 class="detail-section-title d-flex gap-3">
                <i class="bi bi-telephone text-primary"></i>
                Contact Information
            </h5>
            <div class="detail-row">
                <div class="detail-item">
                    <div class="detail-label">Mobile Number</div>
                    <div class="detail-value">{{ employee.mobile_number }}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Official Email</div>
                    <div class="detail-value">{{ employee.official_email }}</div>
                </div>
            </div>
            {% if employee.personal_email %}
            <div class="detail-row">
                <div class="detail-item">
                    <div class="detail-label">Personal Email</div>
                    <div class="detail-value">{{ employee.personal_email }}</div>
                </div>
            </div>
            {% endif %}
            <div class="detail-row">
                <div class="detail-item">
                    <div class="detail-label">Local Address</div>
                    <div class="detail-value">{{ employee.local_address|linebreaksbr }}</div>
                </div>
            </div>
            <div class="detail-row">
                <div class="detail-item">
                    <div class="detail-label">Permanent Address</div>
                    <div class="detail-value">{{ employee.permanent_address|linebreaksbr }}</div>
                </div>
            </div>
        </div>

        <!-- Emergency Contact -->
        <div class="detail-section">
            <h5 class="detail-section-title d-flex gap-3">
                <i class="bi bi-exclamation-triangle text-danger"></i>
                Emergency Contact
            </h5>
            {% if employee.emergency_contact %}
            <div class="detail-row">
                <div class="detail-item">
                    <div class="detail-label">Name</div>
                    <div class="detail-value">{{ employee.emergency_contact.name }}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Relationship</div>
                    <div class="detail-value">{{ employee.emergency_contact.relationship }}</div>
                </div>
            </div>
            <div class="detail-row">
                <div class="detail-item">
                    <div class="detail-label">Mobile</div>
                    <div class="detail-value">{{ employee.emergency_contact.mobile_number }}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Email</div>
                    <div class="detail-value">{{ employee.emergency_contact.email }}</div>
                </div>
            </div>
            {% else %}
            <p class="text-muted">No emergency contact information available.</p>
            {% endif %}
        </div>

        <!-- Personal Information -->
        <div class="detail-section">
            <h5 class="detail-section-title d-flex gap-3">
                <i class="bi bi-person text-info"></i>
                Personal Information
            </h5>
            <div class="detail-row">
                <div class="detail-item">
                    <div class="detail-label">Date of Birth</div>
                    <div class="detail-value">{{ employee.date_of_birth|date:"M d, Y" }}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Age</div>
                    <div class="detail-value">{{ employee.age }} years</div>
                </div>
            </div>
            <div class="detail-row">
                <div class="detail-item">
                    <div class="detail-label">Marital Status</div>
                    <div class="detail-value">{{ employee.get_marital_status_display }}</div>
                </div>
            </div>
            <div class="detail-row">
                <div class="detail-item">
                    <div class="detail-label">Anniversary Date</div>
                    <div class="detail-value">{{ employee.anniversary_date|date:"M d, Y" }}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Column -->
    <div class="col-lg-6">
        <!-- Employment Details -->
        <div class="detail-section">
            <h5 class="detail-section-title d-flex gap-3">
                <i class="bi bi-briefcase text-success"></i>
                Employment Details
            </h5>
            <div class="detail-row">
                <div class="detail-item">
                    <div class="detail-label">Joining Date</div>
                    <div class="detail-value">{{ employee.joining_date|date:"M d, Y" }}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Total Experience</div>
                    <div class="detail-value">{{ employee.total_experience_display }}</div>
                </div>
            </div>
            {% if employee.relieving_date %}
            <div class="detail-row">
                <div class="detail-item">
                    <div class="detail-label">Relieving Date</div>
                    <div class="detail-value">{{ employee.relieving_date|date:"M d, Y" }}</div>
                </div>
            </div>
            {% endif %}
            <div class="detail-row">
                <div class="detail-item">
                    <div class="detail-label">Period Type</div>
                    <div class="detail-value">
                        <span class="status-badge info">
                            {{ employee.get_period_type_display }}
                        </span>
                    </div>
                </div>
            </div>
            <div class="detail-row">
                <div class="detail-item">
                    <div class="detail-label">Employment Status</div>
                    <div class="detail-value">{{ employee.get_employment_status_display }}</div>
                </div>
            </div>
        </div>
        {% if request.user.is_superuser or request.user.is_staff %}
        <div class="detail-section">
            <h5 class="detail-section-title d-flex gap-3">
                <i class="bi bi-file-earmark-text text-primary"></i>
                Identity Documents
            </h5>
            <div class="detail-row">
                <div class="detail-item">
                    <div class="detail-label">PAN Number</div>
                    <div class="detail-value">{{ employee.pan_card_number|default:"—" }}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Aadhar Number</div>
                    <div class="detail-value">{{ employee.aadhar_card_number|default:"—" }}</div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Document Submission Tracker -->
        {% if request.user.is_superuser or request.user.is_staff %}
        <div class="detail-section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="detail-section-title mb-0 d-flex gap-3">
                    <i class="bi bi-check2-all text-success"></i>
                    Document Submission Tracker
                </h5>
                <div class="d-flex gap-2 align-items-center">
                </div>
            </div>
            <div class="document-tracker">
                {% for category_key, category in document_categories.items %}
                <div class="mb-4">
                    <h6 class="text-uppercase font-size-11 fw-bold text-muted mb-3" style="letter-spacing: 0.1em;">
                        {{ category_key }}
                    </h6>
                    <div class="list-group list-group-flush border rounded-3">
                        {% for doc in category %}
                        <div class="list-group-item d-flex justify-content-between align-items-center py-3">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    {% if doc.is_submitted %}
                                    <div class="document-status-icon success"><i class="bi bi-check-lg"></i></div>
                                    {% else %}
                                    <div class="document-status-icon warning"><i class="bi bi-dash"></i></div>
                                    {% endif %}
                                </div>
                                <div class="flex-grow-1">
                                    <div class="fw-medium text-dark">{{ doc.display }}</div>
                                    {% if doc.submitted_date %}
                                    <small class="text-muted">
                                        Submitted on {{ doc.submitted_date|date:"M d, Y" }}
                                    </small>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="form-check form-switch">
                                {% if doc.id %}
                                <input class="form-check-input document-toggle" type="checkbox" id="dt_{{ doc.id }}"
                                    data-id="{{ doc.id }}" {{ doc.is_submitted|yesno:"checked," }} {{
                                    request.user.is_staff|yesno:",disabled" }}>
                                {% else %}
                                <input class="form-check-input document-toggle-new" type="checkbox"
                                    id="dtn_{{ doc.type }}" data-type="{{ doc.type }}" {{
                                    doc.is_submitted|yesno:"checked," }} {{ request.user.is_staff|yesno:",disabled" }}>
                                {% endif %}
                                <label class="form-check-label visually-hidden"
                                    for="dt_{{ doc.id|default:doc.type }}">Toggle</label>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}

                <div
                    class="list-group-item d-flex justify-content-between align-items-center p-3 border rounded-3 bg-light">
                    <div class="fw-medium text-dark">Number of Graduation / Post-Graduation Marksheets</div>
                    <span class="badge bg-primary px-3 py-2 fs-6">{{ employee.graduates_marksheet_count }}</span>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Login Credentials -->
        {% if request.user.is_superuser or request.user.is_staff %}
        <div class="detail-section">
            <h5 class="detail-section-title d-flex gap-3">
                <i class="bi bi-key text-danger"></i>
                Login Credentials
            </h5>
            <div class="detail-row">
                <div class="detail-item">
                    <div class="detail-label">Username</div>
                    <div class="detail-value">{{ employee.user_profile.user.username|default:"No account linked" }}
                    </div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Password (Initial)</div>
                    <div class="detail-value">
                        <span id="password-display">******{{ employee.plain_password|slice:"-3:" }}</span>
                        <button class="btn btn-sm btn-outline-primary ms-2"
                            onclick="copyPassword('{{ employee.plain_password }}')">
                            <i class="bi bi-clipboard"></i> Copy
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Performance Evaluation History -->
<div class="card border-0 shadow-sm mt-4" style="border-radius: 12px; overflow: hidden;">
    <div class="card-header bg-white border-0 pt-4 px-4">
        <h5 class="fw-bold mb-0 text-primary"><i class="bi bi-graph-up-arrow me-2"></i>Performance Evaluation History
        </h5>
        <p class="text-muted small mb-0 mt-1">Status of evaluation cycles for {{ employee.get_period_type_display }}</p>
    </div>
    <div class="card-body p-0 mt-2">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light">
                    <tr>
                        <th class="ps-4">Cycle</th>
                        <th>Period</th>
                        <th>Status</th>
                        <th>Submitted On</th>
                        <th>Approved On</th>
                        <th class="text-end pe-4">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for eval in evaluations %}
                    <tr>
                        <td class="ps-4">
                            <span class="badge bg-secondary rounded-pill">Cycle {{ eval.cycle_number }}</span>
                        </td>
                        <td class="small fw-medium">
                            {{ eval.period_start|date:"d M Y" }} — {{ eval.period_end|date:"d M Y" }}
                        </td>
                        <td>
                            {% if eval.status == 'approved' %}
                            <span
                                class="badge bg-success-subtle text-success border border-success-subtle px-3 rounded-pill">Approved</span>
                            {% elif eval.status == 'pending' %}
                            <span
                                class="badge bg-warning-subtle text-warning-emphasis border border-warning-subtle px-3 rounded-pill">Pending</span>
                            {% elif eval.status == 'rejected' %}
                            <span
                                class="badge bg-danger-subtle text-danger border border-danger-subtle px-3 rounded-pill">Rejected</span>
                            {% else %}
                            <span
                                class="badge bg-info-subtle text-info-emphasis border border-info-subtle px-3 rounded-pill">{{
                                eval.get_status_display }}</span>
                            {% endif %}
                        </td>
                        <td class="text-muted small">{{ eval.submitted_at|date:"d M Y, H:i"|default:"—" }}</td>
                        <td class="text-muted small">{{ eval.approved_at|date:"d M Y, H:i"|default:"—" }}</td>
                        <td class="text-end pe-4">
                            <a href="{% url 'employees:evaluation_detail' eval.pk %}"
                                class="btn btn-sm btn-light border shadow-sm px-3">
                                <i class="bi bi-eye text-primary"></i> View
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center py-5">
                            <div class="text-muted small">
                                <i class="bi bi-info-circle d-block fs-3 mb-2"></i>
                                No evaluations scheduled for this employee.
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<style>
    .bg-success-subtle {
        background-color: #d1e7dd !important;
    }

    .bg-warning-subtle {
        background-color: #fff3cd !important;
    }

    .bg-danger-subtle {
        background-color: #f8d7da !important;
    }

    .bg-info-subtle {
        background-color: #cff4fc !important;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    function copyPassword(password) {
        navigator.clipboard.writeText(password).then(function () {
            showSuccess('Password copied to clipboard!');
        }, function (err) {
            console.error('Could not copy password: ', err);
        });
    }

    // Handle document toggle switches
    document.addEventListener('DOMContentLoaded', function () {
        const toggleElements = document.querySelectorAll('.document-toggle');

        toggleElements.forEach(function (toggle) {
            toggle.addEventListener('change', function () {
                const documentId = this.getAttribute('data-id');
                const isSubmitted = this.checked;

                console.log('Toggle changed:', { documentId, isSubmitted });

                // Update the status icon immediately for better UX
                const listItem = this.closest('.list-group-item');
                const statusIcon = listItem.querySelector('.document-status-icon');
                const iconElement = statusIcon.querySelector('i');

                if (isSubmitted) {
                    statusIcon.classList.remove('warning');
                    statusIcon.classList.add('success');
                    iconElement.classList.remove('bi-dash');
                    iconElement.classList.add('bi-check-lg');
                } else {
                    statusIcon.classList.remove('success');
                    statusIcon.classList.add('warning');
                    iconElement.classList.remove('bi-check-lg');
                    iconElement.classList.add('bi-dash');
                }

                // Send AJAX request to update the database
                const url = `/update-document-status/${documentId}/`;
                console.log('Sending request to:', url);
                console.log('Full URL should be:', window.location.origin + url);

                fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        'is_submitted': isSubmitted
                    })
                })
                    .then(response => {
                        console.log('Response status:', response.status);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Response data:', data);
                        if (data.success) {
                            // Update submitted date if available
                            const dateContainer = listItem.querySelector('small.text-muted');
                            if (data.submitted_date) {
                                if (dateContainer) {
                                    dateContainer.textContent = `Submitted on ${data.submitted_date}`;
                                } else {
                                    const docInfo = listItem.querySelector('div > div:last-child');
                                    const newDateElement = document.createElement('small');
                                    newDateElement.className = 'text-muted';
                                    newDateElement.textContent = `Submitted on ${data.submitted_date}`;
                                    docInfo.appendChild(newDateElement);
                                }
                            } else {
                                if (dateContainer) {
                                    dateContainer.remove();
                                }
                            }

                            // Show success message
                            showToast(`Document status updated to ${isSubmitted ? 'Submitted' : 'Pending'}`, 'success');
                        } else {
                            // Revert toggle on error
                            this.checked = !isSubmitted;
                            showToast('Failed to update document status', 'error');
                        }
                    })
                    .catch(error => {
                        // Revert toggle on error
                        this.checked = !isSubmitted;
                        console.error('Error:', error);
                        showToast('Failed to update document status: ' + error.message, 'error');
                    });
            });
        });

        // Helper function to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Helper function to show toast notifications
        function showToast(message, type = 'info') {
            const toastHtml = `
                <div class="toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;

            // Create toast container if it doesn't exist
            let toastContainer = document.getElementById('toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toast-container';
                toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
                document.body.appendChild(toastContainer);
            }

            // Create and show toast
            const toastElement = document.createElement('div');
            toastElement.innerHTML = toastHtml;
            const toast = new bootstrap.Toast(toastElement.querySelector('.toast'));
            toastContainer.appendChild(toastElement);
            toast.show();

            // Remove toast element after it's hidden
            toastElement.addEventListener('hidden.bs.toast', function () {
                toastElement.remove();
            });
        }

        // Handle document toggle for new documents (that don't exist in DB yet)
        const newToggleElements = document.querySelectorAll('.document-toggle-new');

        newToggleElements.forEach(function (toggle) {
            toggle.addEventListener('change', function () {
                const documentType = this.getAttribute('data-type');
                const employeeId = '{{ employee.id }}';
                const isSubmitted = this.checked;

                console.log('New document toggle changed:', { documentType, employeeId, isSubmitted });

                // Update the status icon immediately for better UX
                const listItem = this.closest('.list-group-item');
                const statusIcon = listItem.querySelector('.document-status-icon');
                const iconElement = statusIcon.querySelector('i');

                if (isSubmitted) {
                    statusIcon.classList.remove('warning');
                    statusIcon.classList.add('success');
                    iconElement.classList.remove('bi-dash');
                    iconElement.classList.add('bi-check-lg');
                } else {
                    statusIcon.classList.remove('success');
                    statusIcon.classList.add('warning');
                    iconElement.classList.remove('bi-check-lg');
                    iconElement.classList.add('bi-dash');
                }

                // Send AJAX request to create/update the document
                const url = `/employee/${employeeId}/document/${documentType}/update/`;
                console.log('Sending request to:', url);

                fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: `is_submitted=${isSubmitted ? 'on' : ''}`
                })
                    .then(response => {
                        console.log('Response status:', response.status);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Response data:', data);
                        if (data.success) {
                            // Show success message
                            showToast(`Document status updated to ${isSubmitted ? 'Submitted' : 'Pending'}`, 'success');

                            // Reload page to get the document ID for future updates
                            setTimeout(() => {
                                location.reload();
                            }, 1000);
                        } else {
                            // Revert toggle on error
                            this.checked = !isSubmitted;
                            showToast('Failed to update document status', 'error');
                        }
                    })
                    .catch(error => {
                        // Revert toggle on error
                        this.checked = !isSubmitted;
                        console.error('Error:', error);
                        showToast('Failed to update document status: ' + error.message, 'error');
                    });
            });
        });
    });
</script>
{% endblock %}