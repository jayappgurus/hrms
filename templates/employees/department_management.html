{% extends 'base.html' %}
{% load static %}

{% block title %}Department Management - HRMS Portal{% endblock %}

{% block page_title %}Department Management{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-white py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-building"></i> Department Management
                    </h5>
                    <div class="d-flex gap-2">
                        <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addDepartmentModal">
                            <i class="bi bi-plus-circle"></i> Add Department
                        </button>
                        <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addDesignationModal">
                            <i class="bi bi-person-plus"></i> Add Designation
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <!-- Departments Section -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h6 class="text-primary mb-3">
                            <i class="bi bi-building"></i> Departments
                        </h6>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Department Name</th>
                                        <th>Description</th>
                                        <th>Designations Count</th>
                                        <th>Employees Count</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for department in departments %}
                                    <tr>
                                        <td>
                                            <strong>{{ department.name }}</strong>
                                        </td>
                                        <td>{{ department.description|default:"No description" }}</td>
                                        <td>
                                            <span class="badge bg-info">{{ department.designation_set.count }}</span>
                                        </td>
                                        <td>
                                            <span class="badge bg-primary">{{ department.employee_set.count }}</span>
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-primary" onclick="editDepartment({{ department.id }})">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="5" class="text-center text-muted">
                                            <i class="bi bi-inbox"></i> No departments found
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Designations Section -->
                <div class="row">
                    <div class="col-12">
                        <h6 class="text-primary mb-3">
                            <i class="bi bi-person-badge"></i> Recent Designations
                        </h6>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Designation Name</th>
                                        <th>Department</th>
                                        <th>Description</th>
                                        <th>Employees Count</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for designation in designations|slice:":20" %}
                                    <tr>
                                        <td>
                                            <strong>{{ designation.name }}</strong>
                                        </td>
                                        <td>
                                            <span class="badge bg-secondary">{{ designation.department.name }}</span>
                                        </td>
                                        <td>{{ designation.description|default:"No description" }}</td>
                                        <td>
                                            <span class="badge bg-success">{{ designation.employee_set.count }}</span>
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-warning" onclick="editDesignation({{ designation.id }})">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="5" class="text-center text-muted">
                                            <i class="bi bi-inbox"></i> No designations found
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Department Modal -->
<div class="modal fade" id="addDepartmentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-building-plus"></i> Add New Department
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" id="departmentForm">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="deptName" class="form-label">Department Name *</label>
                        <input type="text" class="form-control" id="deptName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="deptDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="deptDescription" name="description" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle"></i> Add Department
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Designation Modal -->
<div class="modal fade" id="addDesignationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-person-plus"></i> Add New Designation
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" id="designationForm">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="desigDepartment" class="form-label">Department *</label>
                        <select class="form-select" id="desigDepartment" name="department" required>
                            <option value="">Select Department</option>
                            {% for dept in departments %}
                            <option value="{{ dept.id }}">{{ dept.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="desigName" class="form-label">Designation Name *</label>
                        <input type="text" class="form-control" id="desigName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="desigDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="desigDescription" name="description" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-check-circle"></i> Add Designation
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle department form submission
    document.getElementById('departmentForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);

        fetch('{% url "employees:add_department" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccess('Department added successfully!');
                location.reload();
            } else {
                showError('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError('Error adding department');
        });
    });

    // Handle designation form submission
    document.getElementById('designationForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);

        fetch('{% url "employees:add_designation" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccess('Designation added successfully!');
                location.reload();
            } else {
                showError('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError('Error adding designation');
        });
    });
});

function editDepartment(deptId) {
    showInfo('Edit functionality coming soon! Department ID: ' + deptId, 'Feature Coming Soon');
}

function editDesignation(desigId) {
    showInfo('Edit functionality coming soon! Designation ID: ' + desigId, 'Feature Coming Soon');
}
</script>
{% endblock %}
