{% extends 'base.html' %}



{% block title %}My Profile - HRMS Portal{% endblock %}



{% block page_title %}My Profile{% endblock %}



{% block extra_css %}

<style>

    .profile-header-card {

        background: linear-gradient(135deg, #332666 0%, #332666 100%);

        color: white;

        border-radius: 16px;

        padding: 40px;

        margin-bottom: 24px;

        text-align: center;

    }



    .profile-avatar-large {

        width: 120px;

        height: 120px;

        border-radius: 50%;

        background: #e50880;

        color: #002855;

        background: #332666;

        color: #332666;

        display: flex;

        align-items: center;

        justify-content: center;

        font-size: 48px;

        font-weight: 800;

        margin: 0 auto 24px;

        box-shadow: 0 12px 32px rgba(229, 8, 128, 0.4);

    }

    .profile-avatar-img {

        width: 100%;

        height: 100%;

        object-fit: cover;

        border-radius: 50%;

        transition: all 0.3s ease;

    }



    .quick-stats {

        display: grid;

        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));

        gap: 16px;

        margin-top: 24px;

    }



    .quick-stat-item {

        background: rgba(255, 255, 255, 0.1);

        padding: 16px;

        border-radius: 12px;

        text-align: center;

    }



    .quick-stat-value {

        font-size: 24px;

        font-weight: 700;

        margin-bottom: 4px;

    }



    .quick-stat-label {

        font-size: 13px;

        opacity: 0.9;

    }

</style>

{% endblock %}



{% block content %}

<!-- Profile Header -->

<div class="profile-header-card">

    <div class="profile-avatar-large">

        {% if employee.profile_picture %}

            <img src="{{ employee.profile_picture.url }}"

                 alt="{{ employee.full_name }}"

                 class="profile-avatar-img"

                 onerror="this.style.display='none'; this.parentElement.querySelector('.avatar-fallback').style.display='flex';">

        {% else %}

            <div class="avatar-fallback">{{ employee.full_name|slice:":2"|upper }}</div>

        {% endif %}

    </div>

    <h1 class="h2 mb-2">{{ employee.full_name }}</h1>

    <p class="mb-3 opacity-90">{{ employee.designation.name }}</p>



    <div class="d-flex gap-2 justify-content-center flex-wrap mb-3">

        <span class="badge bg-light text-dark px-3 py-2">

            <i class="bi bi-hash"></i> {{ employee.employee_code }}

        </span>

        <span class="badge bg-light text-dark px-3 py-2">

            <i class="bi bi-building"></i> {{ employee.department.name }}

        </span>

        <span

            class="badge {% if employee.employment_status == 'active' %}bg-success{% else %}bg-danger{% endif %} px-3 py-2">

            <i

                class="bi bi-{% if employee.employment_status == 'active' %}check-circle{% else %}x-circle{% endif %}"></i>

            {{ employee.get_employment_status_display }}

        </span>

    </div>



    <div class="quick-stats">

        <div class="quick-stat-item">

            <div class="quick-stat-value">{{ employee.total_experience_display }}</div>

            <div class="quick-stat-label">Total Experience</div>

        </div>

        <div class="quick-stat-item">

            <div class="quick-stat-value">{{ leave_balance.casual_leave|default:"0" }}</div>

            <div class="quick-stat-label">Casual Leave Balance</div>

        </div>

        <div class="quick-stat-item">

            <div class="quick-stat-value">{{ leave_balance.sick_leave|default:"0" }}</div>

            <div class="quick-stat-label">Sick Leave Balance</div>

        </div>

    </div>

</div>



<div class="row">

    <!-- Left Column -->

    <div class="col-lg-6">

        <!-- Personal Information -->

        <div class="detail-section">

            <h5 class="detail-section-title">

                <i class="bi bi-person text-primary"></i>

                Personal Information

            </h5>

            <div class="detail-row">

                <div class="detail-item">

                    <div class="detail-label">Date of Birth</div>

                    <div class="detail-value">{{ employee.date_of_birth|date:"M d, Y" }}</div>

                </div>

                <div class="detail-item">

                    <div class="detail-label">Age</div>

                    <div class="detail-value">{{ employee.age }} years</div>

                </div>

            </div>

            <div class="detail-row">

                <div class="detail-item">

                    <div class="detail-label">Marital Status</div>

                    <div class="detail-value">{{ employee.get_marital_status_display }}</div>

                </div>

            </div>

            <div class="detail-row">

                <div class="detail-item">

                    <div class="detail-label">Anniversary Date</div>

                    <div class="detail-value">{{ employee.anniversary_date|date:"M d, Y" }}</div>

                </div>

            </div>

        </div>



        <!-- Contact Information -->

        <div class="detail-section">

            <h5 class="detail-section-title">

                <i class="bi bi-telephone text-success"></i>

                Contact Information

            </h5>

            <div class="detail-row">

                <div class="detail-item">

                    <div class="detail-label">Mobile Number</div>

                    <div class="detail-value">{{ employee.mobile_number }}</div>

                </div>

                <div class="detail-item">

                    <div class="detail-label">Official Email</div>

                    <div class="detail-value">{{ employee.official_email }}</div>

                </div>

            </div>

            {% if employee.personal_email %}

            <div class="detail-row">

                <div class="detail-item">

                    <div class="detail-label">Personal Email</div>

                    <div class="detail-value">{{ employee.personal_email }}</div>

                </div>

            </div>

            {% endif %}

            <div class="detail-row">

                <div class="detail-item">

                    <div class="detail-label">Local Address</div>

                    <div class="detail-value">{{ employee.local_address|linebreaksbr }}</div>

                </div>

            </div>

        </div>

    </div>



    <!-- Right Column -->

    <div class="col-lg-6">

        <!-- Employment Details -->

        <div class="detail-section">

            <h5 class="detail-section-title">

                <i class="bi bi-briefcase text-info"></i>

                Employment Details

            </h5>

            <div class="detail-row">

                <div class="detail-item">

                    <div class="detail-label">Joining Date</div>

                    <div class="detail-value">{{ employee.joining_date|date:"M d, Y" }}</div>

                </div>

                <div class="detail-item">

                    <div class="detail-label">Employment Status</div>

                    <div class="detail-value">{{ employee.get_employment_status_display }}</div>

                </div>

            </div>

            <div class="detail-row">

                <div class="detail-item">

                    <div class="detail-label">Period Type</div>

                    <div class="detail-value">

                        <span class="status-badge info">

                            {{ employee.get_period_type_display }}

                        </span>

                    </div>

                </div>

            </div>

        </div>



        <!-- Emergency Contact -->

        <div class="detail-section">

            <h5 class="detail-section-title">

                <i class="bi bi-exclamation-triangle text-danger"></i>

                Emergency Contact

            </h5>

            {% if employee.emergency_contact %}

            <div class="detail-row">

                <div class="detail-item">

                    <div class="detail-label">Name</div>

                    <div class="detail-value">{{ employee.emergency_contact.name }}</div>

                </div>

                <div class="detail-item">

                    <div class="detail-label">Relationship</div>

                    <div class="detail-value">{{ employee.emergency_contact.relationship }}</div>

                </div>

            </div>

            <div class="detail-row">

                <div class="detail-item">

                    <div class="detail-label">Mobile</div>

                    <div class="detail-value">{{ employee.emergency_contact.mobile_number }}</div>

                </div>

                <div class="detail-item">

                    <div class="detail-label">Email</div>

                    <div class="detail-value">{{ employee.emergency_contact.email }}</div>

                </div>

            </div>

            {% else %}

            <p class="text-muted">No emergency contact information available.</p>

            {% endif %}

        </div>



        <!-- Quick Actions -->

        <div class="detail-section">

            <h5 class="detail-section-title">

                <i class="bi bi-lightning text-warning"></i>

                Quick Actions

            </h5>

            <div class="d-grid gap-2">

                <a href="{% url 'employees:edit_user_profile' user.pk %}" class="btn btn-outline-primary">

                    <i class="bi bi-pencil me-2"></i>Edit Profile

                </a>

                <a href="{% url 'employees:device_request_add' %}" class="btn btn-outline-info">

                    <i class="bi bi-laptop me-2"></i>Request Device

                </a>

                <a href="{% url 'employees:leave_application_add' %}" class="btn btn-outline-success">

                    <i class="bi bi-calendar-plus me-2"></i>Apply for Leave

                </a>

                <a href="{% url 'employees:leave_application_list' %}" class="btn btn-outline-info">

                    <i class="bi bi-calendar-check me-2"></i>My Leave Applications

                </a>

            </div>

        </div>

    </div>



    <!-- Device Requests Section -->

    <div class="col-lg-6">

        <!-- Current Device Requests -->

        <div class="detail-section">

            <h5 class="detail-section-title">

                <i class="bi bi-laptop text-info"></i>

                Device Requests

            </h5>

            {% with device_requests=employee.device_requests.all %}

                {% if device_requests %}

                    {% for request in device_requests %}

                    <div class="alert alert-{{ request.status|default:'info' }} mb-2">

                        <div class="d-flex justify-content-between align-items-start">

                            <div>

                                <strong>{{ request.get_device_type_display }}</strong>

                                <span class="badge bg-{{ request.status|default:'secondary' }} ms-2">

                                    {{ request.get_status_display }}

                                </span>

                                <br>

                                <small class="text-muted">

                                    Requested: {{ request.request_date|date:"M d, Y" }}

                                    {% if request.required_date %}| Required: {{ request.required_date|date:"M d, Y" }}{% endif %}

                                </small>

                            </div>

                            {% if request.can_be_returned %}

                            <button type="button" class="btn btn-sm btn-warning" 

                                    onclick="requestDeviceReturn('{{ request.id }}')">>

                                <i class="bi bi-arrow-return-left"></i> Return

                            </button>

                            {% endif %}

                        </div>

                        {% if request.device %}

                        <div class="mt-2">

                            <small>

                                <strong>Allocated Device:</strong> {{ request.device.device_name }}

                                {% if request.device.serial_number %}({{ request.device.serial_number }}){% endif %}

                            </small>

                        </div>

                        {% endif %}

                    </div>

                    {% endfor %}

                {% else %}

                <p class="text-muted">No device requests found.</p>

                <a href="{% url 'employees:device_request_add' %}" class="btn btn-outline-info btn-sm">

                    <i class="bi bi-plus-circle me-1"></i>Request Device

                </a>

                {% endif %}

            {% endwith %}

        </div>

    </div>

</div>



<script>

function requestDeviceReturn(requestId) {

    if (confirm('Are you sure you want to request to return this device?')) {

        fetch(`/employees/device-request/${requestId}/request-return/`, {

            method: 'POST',

            headers: {

                'X-CSRFToken': getCookie('csrftoken'),

                'Content-Type': 'application/json',

            },

        })

        .then(response => response.json())

        .then(data => {

            if (data.success) {

                location.reload();

            } else {

                alert('Error: ' + data.error);

            }

        })

        .catch(error => {

            alert('Error: ' + error.message);

        });

    }

}



function getCookie(name) {

    let cookieValue = null;

    if (document.cookie && document.cookie !== '') {

        const cookies = document.cookie.split(';');

        for (let i = 0; i < cookies.length; i++) {

            const cookie = cookies[i].trim();

            if (cookie.substring(0, name.length + 1) === (name + '=')) {

                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));

                break;

            }

        }

    }

    return cookieValue;

}

</script>

{% endblock %}

