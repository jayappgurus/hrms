{% extends 'base.html' %}
{% load static %}

{% block title %}Employee Grid - HRMS Portal{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/employee-grid.css' %}">
{% endblock %}

{% block page_title %}Employee Grid{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="container-fluid">
    <div class="row align-items-center">
        <div class="col-md-12 text-md-end mb-3">
            <a href="{% url 'employees:employee_add' %}" class="btn btn-primary">
                <i class="bi bi-plus-circle me-2"></i>Add New Employee
            </a>
        </div>
    </div>
</div>

<!-- Statistics Section -->
<div class="container-fluid">
    <div class="stats-section">
        <div class="stat-card">
            <div class="stat-number">{{ total_employees }}</div>
            <div class="stat-label">Total Employees</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ active_employees_count }}</div>
            <div class="stat-label">Active Employees</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ departments|length }}</div>
            <div class="stat-label">Departments</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ is_paginated|yesno:"Paginated,Single Page" }}</div>
            <div class="stat-label">View Mode</div>
        </div>
    </div>
</div>

<!-- Search and Filter Section -->
<div class="container-fluid">
    <div class="search-filter-section">
        <div class="row align-items-center">
            <div class="col-md-4">
                <form method="get" class="d-flex">
                    <input type="text" name="search" class="form-control search-input me-2" 
                           placeholder="Search employees by name or code..." value="{{ search_form.search.value|default:'' }}">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-search"></i>
                    </button>
                </form>
            </div>
            <div class="col-md-8">
                <div class="d-flex gap-2 flex-wrap">
                    <button class="btn filter-btn active" data-filter="all">
                        <i class="bi bi-grid-3x3-gap me-1"></i> All Employees
                    </button>
                    <button class="btn filter-btn" data-filter="active">
                        <i class="bi bi-check-circle me-1"></i> Active Only
                    </button>
                    <button class="btn filter-btn" data-filter="inactive">
                        <i class="bi bi-x-circle me-1"></i> Inactive Only
                    </button>
                    <div class="dropdown">
                        <button class="btn filter-btn dropdown-toggle" type="button" id="departmentDropdown" data-bs-toggle="dropdown">
                            <i class="bi bi-building me-1"></i> Department
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="departmentDropdown">
                            <li><a class="dropdown-item" href="#" data-department="all">All Departments</a></li>
                            {% for dept in departments %}
                            <li><a class="dropdown-item" href="#" data-department="{{ dept.id }}">{{ dept.name }}</a></li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Employee Grid -->
<div class="container-fluid">
    {% if employees %}
    <div class="employee-grid">
        {% for employee in employees %}
        <div class="employee-card" data-status="{{ employee.employment_status }}" data-department="{{ employee.department.id }}">
            <!-- Employee Header -->
            <div class="employee-header">
                <div class="employee-avatar">
                    {{ employee.full_name|slice:":2"|upper }}
                </div>
                <div class="employee-name">{{ employee.full_name }}</div>
                <div class="employee-code">{{ employee.employee_code }}</div>
            </div>
            
            <!-- Employee Body -->
            <div class="employee-body">
                <div class="department-badge">
                    <i class="bi bi-building me-1"></i>{{ employee.department.name }}
                </div>
                
                <div class="employee-info">
                    <div class="info-item">
                        <div class="info-icon">
                            <i class="bi bi-briefcase"></i>
                        </div>
                        <div class="info-content">
                            <div class="info-label">Designation</div>
                            <div class="info-value">{{ employee.designation.name }}</div>
                        </div>
                    </div>
                    
                    <div class="info-item">
                        <div class="info-icon">
                            <i class="bi bi-envelope"></i>
                        </div>
                        <div class="info-content">
                            <div class="info-label">Email</div>
                            <div class="info-value">{{ employee.official_email|truncatechars:25 }}</div>
                        </div>
                    </div>
                    
                    <div class="info-item">
                        <div class="info-icon">
                            <i class="bi bi-telephone"></i>
                        </div>
                        <div class="info-content">
                            <div class="info-label">Phone</div>
                            <div class="info-value">{{ employee.mobile_number }}</div>
                        </div>
                    </div>
                    
                    <div class="info-item">
                        <div class="info-icon">
                            <i class="bi bi-calendar"></i>
                        </div>
                        <div class="info-content">
                            <div class="info-label">Joined</div>
                            <div class="info-value">{{ employee.joining_date|date:"M d, Y" }}</div>
                        </div>
                    </div>
                </div>
                
                <!-- Status Badge -->
                <div class="mt-3">
                    <span class="status-badge {{ employee.employment_status }}">
                        <i class="bi bi-{{ employee.employment_status|yesno:'check-circle,x-circle' }} me-1"></i>
                        {{ employee.get_employment_status_display }}
                    </span>
                </div>
            </div>
            
            <!-- Employee Actions -->
            <div class="employee-actions">
                <a href="{% url 'employees:employee_detail' employee.pk %}" class="action-btn primary">
                    <i class="bi bi-eye"></i> View
                </a>
                <a href="{% url 'employees:employee_edit' employee.pk %}" class="action-btn secondary">
                    <i class="bi bi-pencil"></i> Edit
                </a>
                {% if user.is_superuser %}
                <button class="action-btn secondary" onclick="toggleStatus({{ employee.pk }})">
                    <i class="bi bi-toggle-on"></i> Toggle
                </button>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    
    <!-- Pagination -->
    {% if is_paginated %}
    <div class="pagination-container">
        <nav aria-label="Employee pagination">
            <ul class="pagination">
                {% if page_obj.has_previous %}
                <li>
                    <a class="page-link" href="?page=1{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}">
                        <i class="bi bi-chevron-double-left"></i>
                    </a>
                </li>
                <li>
                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}">
                        <i class="bi bi-chevron-left"></i>
                    </a>
                </li>
                {% endif %}
                
                {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                <li>
                    <span class="page-link active">{{ num }}</span>
                </li>
                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                <li>
                    <a class="page-link" href="?page={{ num }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}">{{ num }}</a>
                </li>
                {% endif %}
                {% endfor %}
                
                {% if page_obj.has_next %}
                <li>
                    <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}">
                        <i class="bi bi-chevron-right"></i>
                    </a>
                </li>
                <li>
                    <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}">
                        <i class="bi bi-chevron-double-right"></i>
                    </a>
                </li>
                {% endif %}
            </ul>
        </nav>
    </div>
    {% endif %}
    
    {% else %}
    <!-- Empty State -->
    <div class="empty-state">
        <div class="empty-state-icon">
            <i class="bi bi-people"></i>
        </div>
        <h3 class="empty-state-title">No Employees Found</h3>
        <p class="empty-state-text">
            {% if search_form.search.value %}
                No employees found matching your search criteria. Try adjusting your search terms.
            {% else %}
                No employees have been added yet. Start by adding your first employee.
            {% endif %}
        </p>
        <a href="{% url 'employees:employee_add' %}" class="btn btn-primary">
            <i class="bi bi-plus-circle me-2"></i>Add First Employee
        </a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Filter functionality
    const filterButtons = document.querySelectorAll('.filter-btn[data-filter]');
    const employeeCards = document.querySelectorAll('.employee-card');
    
    filterButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Remove active class from all buttons
            filterButtons.forEach(btn => btn.classList.remove('active'));
            // Add active class to clicked button
            this.classList.add('active');
            
            const filter = this.dataset.filter;
            
            employeeCards.forEach(card => {
                if (filter === 'all') {
                    card.style.display = 'block';
                } else {
                    const status = card.dataset.status;
                    if (status === filter) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                }
            });
        });
    });
    
    // Department filter
    const departmentLinks = document.querySelectorAll('[data-department]');
    departmentLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            
            const departmentId = this.dataset.department;
            
            employeeCards.forEach(card => {
                if (departmentId === 'all') {
                    card.style.display = 'block';
                } else {
                    const cardDepartment = card.dataset.department;
                    if (cardDepartment === departmentId) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                }
            });
            
            // Update dropdown text
            const dropdown = document.getElementById('departmentDropdown');
            dropdown.innerHTML = '<i class="bi bi-building me-1"></i> ' + this.textContent;
        });
    });
    
    // Search functionality
    const searchInput = document.querySelector('.search-input');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            
            employeeCards.forEach(card => {
                const name = card.querySelector('.employee-name').textContent.toLowerCase();
                const code = card.querySelector('.employee-code').textContent.toLowerCase();
                
                if (name.includes(searchTerm) || code.includes(searchTerm)) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        });
    }
});

// Toggle employee status
function toggleStatus(employeeId) {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    const token = csrfToken ? csrfToken.value : '';
    
    fetch(`/employees/toggle-status/${employeeId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': token,
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while toggling employee status.');
    });
}
</script>
{% endblock %}
