{% extends 'base.html' %}

{% block title %}{% if form.instance.pk %}Edit Employee{% else %}Add Employee{% endif %} - HRMS Portal{% endblock %}

{% block page_title %}{% if form.instance.pk %}Edit Employee{% else %}Add New Employee{% endif %}{% endblock %}

{% block extra_css %}
<style>
    .form-section {
        background: white;
        border-radius: 16px;
        padding: 32px;
        margin-bottom: 24px;
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--border-color);
    }

    .form-section-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 2px solid #f1f5f9;
    }

    .form-section-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        background: linear-gradient(135deg, #00376e 0%, #002855 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
    }

    .form-section-title {
        font-size: 18px;
        font-weight: 700;
        color: var(--text-main);
        margin: 0;
    }

    .form-actions-sticky {
        position: sticky;
        bottom: 0;
        background: white;
        padding: 20px;
        border-top: 2px solid var(--border-color);
        box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.05);
        z-index: 100;
        margin: 0 -32px -32px;
        border-radius: 0 0 16px 16px;
    }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
    <div>
        <h1 class="page-title">
            <i class="bi bi-{% if form.instance.pk %}pencil-square{% else %}person-plus{% endif %} text-primary"></i>
            {% if form.instance.pk %}Edit Employee{% else %}Add New Employee{% endif %}
        </h1>
        <p class="page-subtitle">
            {% if form.instance.pk %}
            Update employee information and details
            {% else %}
            Fill in the details to add a new employee to the system
            {% endif %}
        </p>
    </div>
    <a href="{% url 'employees:employee_list' %}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left me-2"></i>Back to List
    </a>
</div>

<form method="post" id="employeeForm" novalidate data-designations="{{ all_designations|safe }}">
    {% csrf_token %}

    <!-- Core Employee Details -->
    <div class="form-section">
        <div class="form-section-header">
            <div class="form-section-icon">
                <i class="bi bi-person-badge"></i>
            </div>
            <h5 class="form-section-title">Core Employee Details</h5>
        </div>

        <div class="row g-3">
            <div class="col-md-4">
                <div class="modern-form-group">
                    <label class="modern-form-label">{{ form.employee_code.label }}</label>
                    {{ form.employee_code }}
                    {% if form.employee_code.errors %}
                    <div class="text-danger small mt-1">{{ form.employee_code.errors.0 }}</div>
                    {% endif %}
                    <small class="form-help-text">Leave blank to auto-generate</small>
                </div>
            </div>

            <div class="col-md-8">
                <div class="modern-form-group">
                    <label class="modern-form-label required">{{ form.full_name.label }}</label>
                    {{ form.full_name }}
                    {% if form.full_name.errors %}
                    <div class="text-danger small mt-1">{{ form.full_name.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>

            <div class="col-md-6">
                <div class="modern-form-group">
                    <label class="modern-form-label required">{{ form.department.label }}</label>
                    {{ form.department }}
                    {% if form.department.errors %}
                    <div class="text-danger small mt-1">{{ form.department.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>

            <div class="col-md-6">
                <div class="modern-form-group">
                    <label class="modern-form-label required">{{ form.designation.label }}</label>
                    {{ form.designation }}
                    {% if form.designation.errors %}
                    <div class="text-danger small mt-1">{{ form.designation.errors.0 }}</div>
                    {% endif %}
                    <small class="form-help-text">Select a department first to load designations</small>
                </div>
            </div>

            <div class="col-md-4">
                <div class="modern-form-group">
                    <label class="modern-form-label required">{{ form.joining_date.label }}</label>
                    {{ form.joining_date }}
                    {% if form.joining_date.errors %}
                    <div class="text-danger small mt-1">{{ form.joining_date.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>

            <div class="col-md-4">
                <div class="modern-form-group">
                    <label class="modern-form-label">{{ form.relieving_date.label }}</label>
                    {{ form.relieving_date }}
                    {% if form.relieving_date.errors %}
                    <div class="text-danger small mt-1">{{ form.relieving_date.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>

            <div class="col-md-4">
                <div class="modern-form-group">
                    <label class="modern-form-label">{{ form.employment_status.label }}</label>
                    {{ form.employment_status }}
                    {% if form.employment_status.errors %}
                    <div class="text-danger small mt-1">{{ form.employment_status.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Contact Information -->
    <div class="form-section">
        <div class="form-section-header">
            <div class="form-section-icon">
                <i class="bi bi-telephone"></i>
            </div>
            <h5 class="form-section-title">Contact Information</h5>
        </div>

        <div class="row g-3">
            <div class="col-md-6">
                <div class="modern-form-group">
                    <label class="modern-form-label required">{{ form.mobile_number.label }}</label>
                    {{ form.mobile_number }}
                    {% if form.mobile_number.errors %}
                    <div class="text-danger small mt-1">{{ form.mobile_number.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>
            <div class="row g-3">
                <h6>Email Addresses</h6>
                <div class="col-md-6">
                    <div class="modern-form-group">
                        <label class="modern-form-label required">{{ form.official_email.label }}</label>
                        {{ form.official_email }}
                        {% if form.official_email.errors %}
                        <div class="text-danger small mt-1">{{ form.official_email.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="modern-form-group">
                        <label class="modern-form-label">{{ form.personal_email.label }}</label>
                        {{ form.personal_email }}
                        {% if form.personal_email.errors %}
                        <div class="text-danger small mt-1">{{ form.personal_email.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="row g-3">
                <h6>Address</h6>
                <div class="col-md-6">
                    <div class="modern-form-group">
                        <label class="modern-form-label">{{ form.local_address.label }}</label>
                        {{ form.local_address }}
                        {% if form.local_address.errors %}
                        <div class="text-danger small mt-1">{{ form.local_address.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="modern-form-group">
                        <label class="modern-form-label">{{ form.permanent_address.label }}</label>
                        {{ form.permanent_address }}
                        {% if form.permanent_address.errors %}
                        <div class="text-danger small mt-1">{{ form.permanent_address.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="row g-3">
                <h6>Emergency Contact</h6>
                <div class="col-md-6">
                    <div class="modern-form-group">
                        <label class="modern-form-label">{{ form.emergency_contact_name.label }}</label>
                        {{ form.emergency_contact_name }}
                        {% if form.emergency_contact_name.errors %}
                        <div class="text-danger small mt-1">{{ form.emergency_contact_name.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="modern-form-group">
                        <label class="modern-form-label">{{ form.emergency_contact_mobile.label }}</label>
                        {{ form.emergency_contact_mobile }}
                        {% if form.emergency_contact_mobile.errors %}
                        <div class="text-danger small mt-1">{{ form.emergency_contact_mobile.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="modern-form-group">
                        <label class="modern-form-label">{{ form.emergency_contact_email.label }}</label>
                        {{ form.emergency_contact_email }}
                        {% if form.emergency_contact_email.errors %}
                        <div class="text-danger small mt-1">{{ form.emergency_contact_email.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="modern-form-group">
                        <label class="modern-form-label">{{ form.emergency_contact_address.label }}</label>
                        {{ form.emergency_contact_address }}
                        {% if form.emergency_contact_address.errors %}
                        <div class="text-danger small mt-1">{{ form.emergency_contact_address.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-6" style="display: none;">
                    <div class="modern-form-group">
                        <label class="modern-form-label">{{ form.emergency_contact_relationship.label }}</label>
                        {{ form.emergency_contact_relationship }}
                        {% if form.emergency_contact_relationship.errors %}
                        <div class="text-danger small mt-1">{{ form.emergency_contact_relationship.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Personal Information -->
    <div class="form-section">
        <div class="form-section-header">
            <div class="form-section-icon">
                <i class="bi bi-person"></i>
            </div>
            <h5 class="form-section-title">Personal Information</h5>
        </div>
        <div class="row g-3">
            <div class="col-md-4">
                <div class="modern-form-group">
                    <label class="modern-form-label required">{{ form.date_of_birth.label }}</label>
                    {{ form.date_of_birth }}
                    {% if form.date_of_birth.errors %}
                    <div class="text-danger small mt-1">{{ form.date_of_birth.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>
            <div class="col-md-4">
                <div class="modern-form-group">
                    <label class="modern-form-label required">{{ form.marital_status.label }}</label>
                    {{ form.marital_status }}
                    {% if form.marital_status.errors %}
                    <div class="text-danger small mt-1">{{ form.marital_status.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>

            <div class="col-md-4" id="anniversary_section">
                <div class="modern-form-group">
                    <label class="modern-form-label">{{ form.anniversary_date.label }}</label>
                    {{ form.anniversary_date }}
                    {% if form.anniversary_date.errors %}
                    <div class="text-danger small mt-1">{{ form.anniversary_date.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    <div class="form-section">
        <div class="form-section-header">
            <div class="form-section-icon">
                <i class="bi bi-briefcase-fill"></i>
            </div>
            <h5 class="form-section-title">Professional Information</h5>
        </div>
        <div class="row g-3">
            <div class="col-md-3">
                <div class="modern-form-group">
                    <label class="modern-form-label required">{{ form.highest_qualification.label }}</label>
                    {{ form.highest_qualification }}
                    {% if form.highest_qualification.errors %}
                    <div class="text-danger small mt-1">{{ form.highest_qualification.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>
            <div class="col-md-3">
                <div class="modern-form-group">
                    <label class="modern-form-label">{{ form.total_experience_years.label }}</label>
                    {{ form.total_experience_years }}
                    {% if form.total_experience_years.errors %}
                    <div class="text-danger small mt-1">{{ form.total_experience_years.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>

            <div class="col-md-3">
                <div class="modern-form-group">
                    <label class="modern-form-label">{{ form.total_experience_months.label }}</label>
                    {{ form.total_experience_months }}
                    {% if form.total_experience_months.errors %}
                    <div class="text-danger small mt-1">{{ form.total_experience_months.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>

            <div class="col-md-3">
                <div class="modern-form-group">
                    <label class="modern-form-label">{{ form.probation_status.label }}</label>
                    {{ form.probation_status }}
                    {% if form.probation_status.errors %}
                    <div class="text-danger small mt-1">{{ form.probation_status.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>
        </div>

    </div>
    <div class="form-section">
        <div class="form-section-header">
            <div class="form-section-icon">
                <i class="bi bi-person-vcard-fill"></i>
            </div>
            <h5 class="form-section-title">Identity & Compliance Proofs</h5>
        </div>
        <div class="row g-3">
            <div class="col-md-6">
                <div class="modern-form-group">
                    <label class="modern-form-label required">{{ form.aadhar_card_number.label }}</label>
                    {{ form.aadhar_card_number }}
                    {% if form.aadhar_card_number.errors %}
                    <div class="text-danger small mt-1">{{ form.aadhar_card_number.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>

            <div class="col-md-6">
                <div class="modern-form-group">
                    <label class="modern-form-label required">{{ form.pan_card_number.label }}</label>
                    {{ form.pan_card_number }}
                    {% if form.pan_card_number.errors %}
                    <div class="text-danger small mt-1">{{ form.pan_card_number.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>
        </div>

    </div>

    <!-- Form Actions -->
    <div class="form-actions-sticky">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
            <a href="{% url 'employees:employee_list' %}" class="btn btn-outline-secondary">
                <i class="bi bi-x-circle me-2"></i>Cancel
            </a>
            <div class="d-flex gap-2">
                <button type="reset" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-clockwise me-2"></i>Reset
                </button>
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check-circle me-2"></i>
                    {% if form.instance.pk %}Update Employee{% else %}Add Employee{% endif %}
                </button>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
    // Add modern-form-control class to all form inputs
    document.addEventListener('DOMContentLoaded', function () {
        const formInputs = document.querySelectorAll('#employeeForm input, #employeeForm select, #employeeForm textarea');
        formInputs.forEach(input => {
            input.classList.add('modern-form-control');
            if (input.tagName === 'SELECT') {
                input.classList.add('modern-form-select');
            }
            if (input.tagName === 'TEXTAREA') {
                input.classList.add('modern-form-textarea');
            }
        });

        // Form validation feedback
        const form = document.getElementById('employeeForm');
        form.addEventListener('submit', function (e) {
            // Temporarily allow form submission without validation for testing
            console.log('Form submitting...');
            // form.classList.add('was-validated');
        });

        // Department-Designation dependency
        const departmentField = document.getElementById('id_department');
        const designationField = document.getElementById('id_designation');

        // Store all designations data from Django template
        const allDesignations = JSON.parse(document.getElementById('employeeForm').getAttribute('data-designations'));
        console.log('Designations loaded successfully:', allDesignations.length);

        function loadDesignations(departmentId) {
            console.log('Loading designations for department:', departmentId);

            // Clear current designation options
            designationField.innerHTML = '<option value="">Select a designation</option>';

            // Filter designations by department if selected, otherwise show all
            const filteredDesignations = departmentId ?
                allDesignations.filter(d => d.department_id == departmentId) :
                allDesignations;

            console.log('Filtered designations:', filteredDesignations);

            if (filteredDesignations.length === 0) {
                designationField.innerHTML = '<option value="">No designations available</option>';
            } else {
                filteredDesignations.forEach(designation => {
                    const option = document.createElement('option');
                    option.value = designation.id;
                    option.textContent = designation.name;
                    designationField.appendChild(option);
                });
            }
        }

        departmentField.addEventListener('change', function () {
            loadDesignations(this.value);
        });

        // Load designations on page load
        loadDesignations(departmentField.value);

        // Anniversary date toggle
        const maritalStatusField = document.getElementById('id_marital_status');
        const anniversarySection = document.getElementById('anniversary_section');

        function toggleAnniversary() {
            if (maritalStatusField.value === 'married') {
                anniversarySection.style.display = 'block';
            } else {
                anniversarySection.style.display = 'none';
            }
        }

        maritalStatusField.addEventListener('change', toggleAnniversary);
        toggleAnniversary(); // Run on load
    });
</script>
{% endblock %}