{% extends 'base.html' %}

{% block title %}{% if form.instance.pk %}Edit Job{% else %}Create Job{% endif %} - HRMS Portal{% endblock %}

{% block page_title %}{% if form.instance.pk %}Edit Job Description{% else %}Create Job Description{% endif %}
{%endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
    <div>
        <h1 class="page-title">
            <i class="bi bi-briefcase text-primary"></i>
            {% if form.instance.pk %}Edit Job Description{% else %}Create Job Description{% endif %}
        </h1>
        <p class="page-subtitle">Define job requirements and responsibilities</p>
    </div>
    <a href="{% url 'employees:job_list' %}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left me-2"></i>Back to Jobs
    </a>
</div>

<form method="post" id="jobForm" enctype="multipart/form-data" data-designations="{{ all_designations|safe }}">
    {% csrf_token %}

    <!-- Basic Information -->
    <div class="modern-card mb-4">
        <div class="modern-card-header">
            <h5 class="modern-card-title">
                <i class="bi bi-info-circle"></i>
                Basic Information
            </h5>
        </div>
        <div class="modern-card-body">
            <div class="row g-3">
                <div class="col-md-12">
                    <div class="modern-form-group">
                        <label class="modern-form-label required">{{ form.title.label }}</label>
                        {{ form.title }}
                        {% if form.title.errors %}
                        <div class="text-danger small mt-1">{{ form.title.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="modern-form-group">
                        <label class="modern-form-label required">{{ form.department.label }}</label>
                        {{ form.department }}
                        {% if form.department.errors %}
                        <div class="text-danger small mt-1">{{ form.department.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="modern-form-group">
                        <label class="modern-form-label required">{{ form.designation.label }}</label>
                        {{ form.designation }}
                        {% if form.designation.errors %}
                        <div class="text-danger small mt-1">{{ form.designation.errors.0 }}</div>
                        {% endif %}
                        <small class="form-help-text">Select a department first to load designations</small>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="modern-form-group">
                        <label class="modern-form-label">{{ form.employment_type.label }}</label>
                        {{ form.employment_type }}
                        {% if form.employment_type.errors %}
                        <div class="text-danger small mt-1">{{ form.employment_type.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="modern-form-group">
                        <label class="modern-form-label">{{ form.experience_level.label }}</label>
                        {{ form.experience_level }}
                        {% if form.experience_level.errors %}
                        <div class="text-danger small mt-1">{{ form.experience_level.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="modern-form-group">
                        <label class="modern-form-label">{{ form.status.label }}</label>
                        {{ form.status }}
                        {% if form.status.errors %}
                        <div class="text-danger small mt-1">{{ form.status.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="col-md-3">
                    <div class="modern-form-group">
                        <label class="modern-form-label">{{ form.location.label }}</label>
                        {{ form.location }}
                        {% if form.location.errors %}
                        <div class="text-danger small mt-1">{{ form.location.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="col-md-3">
                    <div class="modern-form-group">
                        <label class="modern-form-label">{{ form.number_of_vacancies.label }}</label>
                        {{ form.number_of_vacancies }}
                        {% if form.number_of_vacancies.errors %}
                        <div class="text-danger small mt-1">{{ form.number_of_vacancies.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="col-md-3">
                    <div class="modern-form-group">
                        <label class="modern-form-label">{{ form.application_deadline.label }}</label>
                        {{ form.application_deadline }}
                        {% if form.application_deadline.errors %}
                        <div class="text-danger small mt-1">{{ form.application_deadline.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="col-md-3">
                    <div class="modern-form-group">
                        <label class="modern-form-label">{{ form.work_mode.label }}</label>
                        {{ form.work_mode }}
                        {% if form.work_mode.errors %}
                        <div class="text-danger small mt-1">{{ form.work_mode.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Job Details -->
    <div class="modern-card mb-4">
        <div class="modern-card-header">
            <h5 class="modern-card-title">
                <i class="bi bi-file-text"></i>
                Job Details
            </h5>
        </div>
        <div class="modern-card-body">
            <div class="row g-3">
                <div class="col-12">
                    <div class="modern-form-group">
                        <label class="modern-form-label required">{{ form.required_qualifications.label }}</label>
                        {{ form.required_qualifications }}
                        {% if form.required_qualifications.errors %}
                        <div class="text-danger small mt-1">{{ form.required_qualifications.errors.0 }}</div>
                        {% endif %}
                        <small class="form-help-text">List required qualifications for the role</small>
                    </div>
                </div>

                <div class="col-12">
                    <div class="modern-form-group">
                        <label class="modern-form-label required">{{ form.skills_requirements.label }}</label>
                        {{ form.skills_requirements }}
                        {% if form.skills_requirements.errors %}
                        <div class="text-danger small mt-1">{{ form.skills_requirements.errors.0 }}</div>
                        {% endif %}
                        <small class="form-help-text">List required skills and competencies</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Compensation -->
    <div class="modern-card mb-4">
        <div class="modern-card-header">
            <h5 class="modern-card-title">
                <i class="bi bi-currency-dollar"></i>
                Compensation
            </h5>
        </div>
        <div class="modern-card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <div class="modern-form-group">
                        <label class="modern-form-label">{{ form.min_salary.label }}</label>
                        {{ form.min_salary }}
                        {% if form.min_salary.errors %}
                        <div class="text-danger small mt-1">{{ form.min_salary.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="modern-form-group">
                        <label class="modern-form-label">{{ form.max_salary.label }}</label>
                        {{ form.max_salary }}
                        {% if form.max_salary.errors %}
                        <div class="text-danger small mt-1">{{ form.max_salary.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="modern-form-group">
                        <label class="modern-form-label">{{ form.currency.label }}</label>
                        {{ form.currency }}
                        {% if form.currency.errors %}
                        <div class="text-danger small mt-1">{{ form.currency.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Form Actions -->
    <div class="d-flex justify-content-end gap-2">
        <a href="{% url 'employees:job_list' %}" class="btn btn-outline-secondary">
            <i class="bi bi-x-circle me-2"></i>Cancel
        </a>
        <button type="submit" class="btn btn-primary">
            <i class="bi bi-check-circle me-2"></i>
            {% if form.instance.pk %}Update Job{% else %}Create Job{% endif %}
        </button>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const formInputs = document.querySelectorAll('#jobForm input, #jobForm select, #jobForm textarea');
        formInputs.forEach(input => {
            input.classList.add('modern-form-control');
            if (input.tagName === 'SELECT') {
                input.classList.add('modern-form-select');
            }
            if (input.tagName === 'TEXTAREA') {
                input.classList.add('modern-form-textarea');
            }
        });

        // Department-Designation dependency
        const departmentField = document.getElementById('id_department');
        const designationField = document.getElementById('id_designation');
        const formTag = document.getElementById('jobForm');

        if (departmentField && designationField && formTag) {
            // Store all designations data from Django template
            const allDesignations = JSON.parse(formTag.getAttribute('data-designations'));
            console.log('Designations loaded successfully:', allDesignations.length);

            function loadDesignations(departmentId) {
                console.log('Loading designations for department:', departmentId);

                // Store current selection to restore if possible
                const currentSelection = designationField.value;

                // Clear current designation options
                designationField.innerHTML = '<option value="">Select a designation</option>';

                // Filter designations by department if selected, otherwise show all
                const filteredDesignations = departmentId ?
                    allDesignations.filter(d => d.department_id == departmentId) :
                    allDesignations;

                console.log('Filtered designations:', filteredDesignations);

                if (filteredDesignations.length === 0) {
                    designationField.innerHTML = '<option value="">No designations available</option>';
                } else {
                    filteredDesignations.forEach(designation => {
                        const option = document.createElement('option');
                        option.value = designation.id;
                        option.textContent = designation.name;
                        if (designation.id == currentSelection) {
                            option.selected = true;
                        }
                        designationField.appendChild(option);
                    });
                }
            }

            departmentField.addEventListener('change', function () {
                loadDesignations(this.value);
            });

            // Load designations on page load
            loadDesignations(departmentField.value);
        }

        // Form validation and submission
        const jobForm = document.getElementById('jobForm');
        if (jobForm) {
            jobForm.addEventListener('submit', function (e) {
                // Basic validation
                const title = document.querySelector('[name="title"]');
                const jobDescription = document.querySelector('[name="job_description"]');

                if (!title || !title.value.trim()) {
                    e.preventDefault();
                    showWarning('Please enter a job title', 'Validation Error');
                    title.focus();
                    return false;
                }

                if (!jobDescription || !jobDescription.value.trim()) {
                    e.preventDefault();
                    showWarning('Please enter a job description', 'Validation Error');
                    jobDescription.focus();
                    return false;
                }

                // Show loading state
                const submitBtn = document.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Saving...';
                }

                return true;
            });
        }
    });
</script>
{% endblock %}