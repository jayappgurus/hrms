{% extends 'base.html' %}
{% load static %}

{% block title %}{% if form.instance.pk %}Edit Leave Type{% else %}Add Leave Type{% endif %}{% endblock %}

{% block page_title %}{% if form.instance.pk %}Edit Leave Type{% else %}Add Leave Type{% endif %}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card" style="border-radius: 20px; box-shadow: 0 10px 30px rgba(0, 55, 110, 0.1);">
                <div class="card-header" style="background: #332666; color: white; border-radius: 20px 20px 0 0;">
                    <h5 class="mb-0">
                        <i class="bi bi-{% if form.instance.pk %}pencil{% else %}plus-circle{% endif %} me-2"></i>
                        {% if form.instance.pk %}Edit Leave Type{% else %}Add Leave Type{% endif %}
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" novalidate>
                        {% csrf_token %}
                        
                        <div class="row">
                            <div class="col-md-6 mb-3 d-none" id="name-field-container">
                                <label for="{{ form.name.id_for_label }}" class="form-label">{{ form.name.label }}</label>
                                {{ form.name }}
                                {% if form.name.errors %}
                                    <div class="text-danger">
                                        {% for error in form.name.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.leave_type.id_for_label }}" class="form-label">{{ form.leave_type.label }}</label>
                                {{ form.leave_type }}
                                {% if form.leave_type.errors %}
                                    <div class="text-danger">
                                        {% for error in form.leave_type.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="{{ form.max_days_per_year.id_for_label }}" class="form-label">Leave Duration</label>
                                <div class="input-group">
                                    {{ form.max_days_per_year }}
                                    {{ form.duration_type }}
                                </div>
                                {% if form.max_days_per_year.errors %}
                                    <div class="text-danger">
                                        {% for error in form.max_days_per_year.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label class="form-label">{{ form.is_paid.label }}</label>
                                <div class="form-check">
                                    {{ form.is_paid }}
                                    <label class="form-check-label" for="{{ form.is_paid.id_for_label }}">
                                        Paid Leave
                                    </label>
                                </div>
                                {% if form.is_paid.errors %}
                                    <div class="text-danger">
                                        {% for error in form.is_paid.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label class="form-label">{{ form.requires_document.label }}</label>
                                <div class="form-check">
                                    {{ form.requires_document }}
                                    <label class="form-check-label" for="{{ form.requires_document.id_for_label }}">
                                        Document Required
                                    </label>
                                </div>
                                {% if form.requires_document.errors %}
                                    <div class="text-danger">
                                        {% for error in form.requires_document.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.description.id_for_label }}" class="form-label">Rules</label>
                            
                            <!-- Rich Text Editor Toolbar -->
                            <div class="btn-toolbar mb-2" role="toolbar">
                                <div class="btn-group me-2" role="group">
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatText('bold')" title="Bold">
                                        <i class="bi bi-type-bold"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatText('italic')" title="Italic">
                                        <i class="bi bi-type-italic"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatText('underline')" title="Underline">
                                        <i class="bi bi-type-underline"></i>
                                    </button>
                                </div>
                                <div class="btn-group me-2" role="group">
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatText('insertUnorderedList')" title="Unordered List">
                                        <i class="bi bi-list-ul"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatText('insertOrderedList')" title="Ordered List">
                                        <i class="bi bi-list-ol"></i>
                                    </button>
                                </div>
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearFormatting()" title="Clear Formatting">
                                        <i class="bi bi-eraser"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Rich Text Editor -->
                            <div id="rules-editor" contenteditable="true" class="form-control rich-text-editor" style="min-height: 120px; max-height: 300px; overflow-y: auto; border: 1px solid #ced4da; border-radius: 0.375rem; padding: 0.375rem 0.75rem;" placeholder="Enter rules and regulations for this leave type..."></div>
                            
                            <!-- Hidden field to store the content -->
                            <textarea name="{{ form.description.name }}" id="{{ form.description.id_for_label }}" style="display: none;">{{ form.description.value|default:'' }}</textarea>
                            
                            {% if form.description.errors %}
                                <div class="text-danger">
                                    {% for error in form.description.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">{{ form.is_active.label }}</label>
                            <div class="form-check">
                                {{ form.is_active }}
                                <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
                                    Active Status
                                </label>
                            </div>
                            {% if form.is_active.errors %}
                                <div class="text-danger">
                                    {% for error in form.is_active.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="d-flex justify-content-end gap-2">
                            <a href="{% url 'employees:leave_types' %}" class="btn btn-secondary">
                                <i class="bi bi-arrow-left me-2"></i>Back to List
                            </a>
                            <button type="submit" class="btn" style="background: #332666; color: white; border-radius: 20px;">
                                <i class="bi bi-{% if form.instance.pk %}check-lg{% else %}plus-circle{% endif %} me-2"></i>
                                {% if form.instance.pk %}Update Leave Type{% else %}Add Leave Type{% endif %}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const editor = document.getElementById('rules-editor');
    const hiddenField = document.getElementById('{{ form.description.id_for_label }}');
    
    // Load existing content into editor
    if (hiddenField.value) {
        editor.innerHTML = hiddenField.value;
    }
    
    // Sync editor content to hidden field on input
    editor.addEventListener('input', function() {
        hiddenField.value = editor.innerHTML;
    });
    
    // Handle placeholder
    function updatePlaceholder() {
        if (editor.innerHTML.trim() === '') {
            editor.setAttribute('data-placeholder', 'Enter rules and regulations for this leave type...');
        } else {
            editor.removeAttribute('data-placeholder');
        }
    }
    
    editor.addEventListener('focus', updatePlaceholder);
    editor.addEventListener('blur', updatePlaceholder);
    editor.addEventListener('input', updatePlaceholder);
    updatePlaceholder();
});

function formatText(command) {
    document.execCommand(command, false, null);
    document.getElementById('rules-editor').focus();
}

function clearFormatting() {
    document.execCommand('removeFormat', false, null);
    document.getElementById('rules-editor').focus();
}
</script>

<style>
.rich-text-editor[data-placeholder]:empty:before {
    content: attr(data-placeholder);
    color: #6c757d;
    font-style: italic;
}

.rich-text-editor:focus {
    outline: none;
    border-color: #86b7fe;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

.btn-toolbar .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}

.btn-toolbar .btn:hover {
    background-color: #e9ecef;
    border-color: #adb5bd;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const leaveTypeSelect = document.getElementById('{{ form.leave_type.id_for_label }}');
    const nameField = document.getElementById('{{ form.name.id_for_label }}');
    const nameFieldContainer = document.getElementById('name-field-container');
    
    // Function to update name field based on leave type selection
    function updateNameField() {
        const selectedOption = leaveTypeSelect.options[leaveTypeSelect.selectedIndex];
        const leaveTypeText = selectedOption.text;
        
        if (leaveTypeSelect.value) {
            // Auto-populate the name field with the selected leave type text
            nameField.value = leaveTypeText;
            nameFieldContainer.classList.add('d-none'); // Hide the name field
        } else {
            nameField.value = '';
            nameFieldContainer.classList.remove('d-none'); // Show the name field if no selection
        }
    }
    
    // Add event listener to leave type select
    leaveTypeSelect.addEventListener('change', updateNameField);
    
    // Initialize on page load
    updateNameField();
    
    // For edit forms, if there's already a value, keep the field hidden
    {% if form.instance.pk %}
        if (nameField.value) {
            nameFieldContainer.classList.add('d-none');
        }
    {% endif %}
});
</script>
{% endblock %}
