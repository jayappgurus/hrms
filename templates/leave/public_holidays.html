{% extends 'base.html' %}

{% block title %}Public Holidays - HRMS Portal{% endblock %}

{% block page_title %}Public Holidays{% endblock %}

{% block content %}
<!-- Hidden CSRF token for JavaScript -->
{% csrf_token %}

<!-- Page Header -->
<div class="page-header">
    <div>
        <h1 class="page-title">
            <i class="bi bi-calendar-event text-primary"></i>
            Public Holidays
        </h1>
        <p class="page-subtitle">Manage company holidays and observances</p>
    </div>
    {% if user.is_superuser or user.is_staff %}
    <div class="d-flex gap-2">
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown"
                aria-expanded="false">
                <i class="bi bi-file-earmark-spreadsheet me-2"></i>CSV
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="{% url 'employees:export_public_holidays_csv' %}">
                        <i class="bi bi-download me-2"></i>Export CSV
                    </a></li>
                <li><a class="dropdown-item" href="{% url 'employees:import_public_holidays_csv' %}">
                        <i class="bi bi-upload me-2"></i>Import CSV
                    </a></li>
                <li>
                    <hr class="dropdown-divider">
                </li>
                <li><a class="dropdown-item" href="{% url 'employees:download_public_holiday_sample_csv' %}">
                        <i class="bi bi-file-earmark-text me-2"></i>Download Sample
                    </a></li>
            </ul>
        </div>
        <a href="{% url 'employees:public_holiday_add' %}" class="btn btn-primary">
            <i class="bi bi-plus-circle me-2"></i>Add Holiday
        </a>
        <button type="button" class="btn btn-danger" id="bulkDeleteBtn" style="display: none;">
            <i class="bi bi-trash me-2"></i>Delete Selected (<span id="selectedCount">0</span>)
        </button>
    </div>
    {% endif %}
</div>

<!-- Holidays Table -->
<div class="modern-card">
    <div class="modern-card-header">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
            <div>
                <h5 class="modern-card-title mb-0">
                    <i class="bi bi-list-ul"></i>
                    Public Holidays
                </h5>
            </div>
            <div class="filter-pills">
                {% regroup holidays by year as holidays_by_year %}
                {% for year_group in holidays_by_year reversed %}
                <button class="filter-pill {% if year_group.grouper == 2026 %}active{% endif %}"
                    data-year="{{ year_group.grouper }}">
                    {{ year_group.grouper }}</button>
                {% endfor %}
            </div>
        </div>
    </div>
    <div class="modern-card-body p-0">

        <div class="table-responsive">
            {% if holidays %}
            <table class="modern-table">
                <thead>
                    <tr>
                        {% if user.is_superuser or user.is_staff %}
                        <th>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="selectAll">
                                <label class="form-check-label" for="selectAll"></label>
                            </div>
                        </th>
                        {% endif %}
                        <th>No</th>
                        <th>Holiday Name</th>
                        <th>Date</th>
                        <th>Day</th>
                        <th>Country</th>
                        <th>Type</th>
                        {% if user.is_superuser or user.is_staff %}
                        <th class="text-end">Actions</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% for holiday in holidays %}
                    <tr data-year="{{ holiday.year }}" data-holiday-id="{{ holiday.pk }}">
                        {% if user.is_superuser or user.is_staff %}
                        <td data-label="Select">
                            <div class="form-check">
                                <input class="form-check-input holiday-checkbox" type="checkbox" value="{{ holiday.pk }}">
                                <label class="form-check-label"></label>
                            </div>
                        </td>
                        {% endif %}
                        <td data-label="#">
                            <span class="fw-medium text-muted holiday-counter">{{ forloop.counter }}</span>
                        </td>
                        <td data-label="Holiday Name">
                            <div class="d-flex align-items-center gap-3">
                                <div class="info-icon">
                                    <i class="bi bi-calendar-event"></i>
                                </div>
                                <div>
                                    <div class="fw-semibold">{{ holiday.name }}</div>
                                    {% if holiday.description %}
                                    <small class="text-muted">{{ holiday.description|truncatewords:10 }}</small>
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                        <td data-label="Date">
                            <span class="fw-medium">{{ holiday.date|date:"M d, Y" }}</span>
                        </td>
                        <td data-label="Day">
                            <span class="status-badge info">
                                {{ holiday.date|date:"l" }}
                            </span>
                        </td>
                        <td data-label="Country">
                            {% if holiday.country %}
                            <span class="status-badge primary">
                                <i class="bi bi-geo-alt me-1"></i>{{ holiday.get_country_display }}
                            </span>
                            {% else %}
                            <span class="status-badge secondary">
                                <i class="bi bi-dash-circle me-1"></i>Not Set
                            </span>
                            {% endif %}
                        </td>
                        <td data-label="Type">
                            {% if holiday.is_optional == True %}
                            <span class="status-badge warning">
                                <i class="bi bi-star me-1"></i>Optional
                            </span>
                            {% elif holiday.is_optional == False %}
                            <span class="status-badge success">
                                <i class="bi bi-check-circle me-1"></i>Mandatory
                            </span>
                            {% else %}
                            <span class="status-badge secondary">
                                <i class="bi bi-dash-circle me-1"></i>Not Set
                            </span>
                            {% endif %}
                        </td>
                        {% if user.is_superuser or user.is_staff %}
                        <td data-label="Actions" class="text-end">
                            <div class="table-actions justify-content-end">
                                <a href="{% url 'employees:public_holiday_edit' holiday.pk %}" class="action-icon-btn"
                                    title="Edit">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                <a href="#" class="action-icon-btn danger"
                                    onclick="confirmDelete({{ holiday.pk }}); return false;" title="Delete">
                                    <i class="bi bi-trash"></i>
                                </a>
                            </div>
                        </td>
                        {% endif %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-4">
            <div class="text-muted">
                <i class="bi bi-calendar-x" style="font-size: 3rem; opacity: 0.3;"></i>
                <h5 class="mt-3">No holidays found</h5>
                <p>Add holidays to see them here.</p>
            </div>
        </div>
        {% endif %}
    </div>
</div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        console.log('=== Public Holidays Page Loaded ===');

        // Year filter functionality
        function initializeYearFilter() {
            const filterPills = document.querySelectorAll('.filter-pill[data-year]');
            const tableRows = document.querySelectorAll('tbody tr[data-year]');

            console.log('Filter pills found:', filterPills.length);
            console.log('Table rows found:', tableRows.length);

            // Function to filter rows by year
            function filterByYear(year) {
                console.log('Filtering by year:', year);
                let counter = 1;

                tableRows.forEach(row => {
                    const rowYear = row.dataset.year;
                    const shouldShow = rowYear === year;

                    if (shouldShow) {
                        row.style.display = 'table-row';
                        // Update row number
                        const rowNumberCell = row.querySelector('td[data-label="#"] span');
                        if (rowNumberCell) {
                            rowNumberCell.textContent = counter;
                            counter++;
                        }
                    } else {
                        row.style.display = 'none';
                        // Uncheck hidden rows
                        const checkbox = row.querySelector('.holiday-checkbox');
                        if (checkbox && checkbox.checked) {
                            checkbox.checked = false;
                        }
                    }
                });
                
                // Update bulk delete button after filtering
                const event = new Event('change');
                const firstCheckbox = document.querySelector('.holiday-checkbox');
                if (firstCheckbox) {
                    firstCheckbox.dispatchEvent(event);
                }
            }

            // Add click handlers to filter pills
            filterPills.forEach(pill => {
                pill.addEventListener('click', function () {
                    // Update active pill
                    filterPills.forEach(p => p.classList.remove('active'));
                    this.classList.add('active');

                    const year = this.dataset.year;
                    filterByYear(year);
                });
            });

            // Apply initial filter based on active pill
            const activePill = document.querySelector('.filter-pill.active');
            if (activePill) {
                const initialYear = activePill.dataset.year;
                console.log('Initial year filter:', initialYear);
                filterByYear(initialYear);
            }
        }

        // Initialize year filter on page load
        initializeYearFilter();

        // Multi-select functionality
        function initializeMultiSelect() {
            const selectAllCheckbox = document.getElementById('selectAll');
            const holidayCheckboxes = document.querySelectorAll('.holiday-checkbox');
            const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
            const selectedCountSpan = document.getElementById('selectedCount');

            console.log('=== Multi-select Initialization ===');
            console.log('Select all checkbox:', selectAllCheckbox);
            console.log('Holiday checkboxes found:', holidayCheckboxes.length);
            console.log('Bulk delete button:', bulkDeleteBtn);
            console.log('Selected count span:', selectedCountSpan);

            if (!bulkDeleteBtn) {
                console.error('CRITICAL: Bulk delete button not found in DOM!');
                return;
            }

            if (!selectedCountSpan) {
                console.error('CRITICAL: Selected count span not found in DOM!');
                return;
            }

            // Function to update bulk delete button visibility and count
            function updateBulkDeleteButton() {
                const checkedBoxes = document.querySelectorAll('.holiday-checkbox:checked');
                const count = checkedBoxes.length;
                
                console.log('Updating button - Checked count:', count);
                
                selectedCountSpan.textContent = count;
                
                if (count > 0) {
                    bulkDeleteBtn.style.display = 'inline-block';
                    console.log('Button shown');
                } else {
                    bulkDeleteBtn.style.display = 'none';
                    console.log('Button hidden');
                }
            }

            // Select all functionality
            if (selectAllCheckbox) {
                selectAllCheckbox.addEventListener('change', function() {
                    console.log('Select all clicked:', this.checked);
                    const isChecked = this.checked;
                    holidayCheckboxes.forEach(checkbox => {
                        checkbox.checked = isChecked;
                    });
                    updateBulkDeleteButton();
                });
            }

            // Individual checkbox functionality
            holidayCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    console.log('Checkbox changed:', this.value, this.checked);
                    updateBulkDeleteButton();
                    
                    // Update select all checkbox state
                    const totalCheckboxes = holidayCheckboxes.length;
                    const checkedCheckboxes = document.querySelectorAll('.holiday-checkbox:checked').length;
                    
                    if (selectAllCheckbox) {
                        if (checkedCheckboxes === 0) {
                            selectAllCheckbox.checked = false;
                            selectAllCheckbox.indeterminate = false;
                        } else if (checkedCheckboxes === totalCheckboxes) {
                            selectAllCheckbox.checked = true;
                            selectAllCheckbox.indeterminate = false;
                        } else {
                            selectAllCheckbox.checked = false;
                            selectAllCheckbox.indeterminate = true;
                        }
                    }
                });
            });

            // Bulk delete button click handler
            bulkDeleteBtn.addEventListener('click', function(e) {
                e.preventDefault();
                console.log('=== Bulk Delete Button Clicked ===');
                
                const checkedBoxes = document.querySelectorAll('.holiday-checkbox:checked');
                const holidayIds = Array.from(checkedBoxes).map(cb => cb.value);
                
                console.log('Checked boxes:', checkedBoxes.length);
                console.log('Holiday IDs:', holidayIds);
                
                if (holidayIds.length === 0) {
                    alert('Please select at least one holiday to delete.');
                    return;
                }
                
                if (confirm(`Are you sure you want to delete ${holidayIds.length} holiday(s)? This action cannot be undone.`)) {
                    console.log('User confirmed deletion');
                    bulkDeleteHolidays(holidayIds);
                } else {
                    console.log('User cancelled deletion');
                }
            });
            
            console.log('Multi-select initialization complete');
        }

        // Initialize multi-select on page load
        initializeMultiSelect();
    });

    function confirmDelete(holidayId) {
        if (confirm('Are you sure you want to delete this holiday?')) {
            window.location.href = '/holidays/' + holidayId + '/delete/';
        }
    }

    // Bulk delete function
    function bulkDeleteHolidays(holidayIds) {
        console.log('=== BULK DELETE FUNCTION CALLED ===');
        console.log('Holiday IDs to delete:', holidayIds);
        
        // Get CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (!csrfToken) {
            console.error('CSRF token not found!');
            alert('Security token not found. Please refresh the page and try again.');
            return;
        }
        
        const tokenValue = csrfToken.value;
        console.log('CSRF token found:', tokenValue.substring(0, 10) + '...');
        
        // Prepare request data
        const requestData = {
            holiday_ids: holidayIds
        };
        console.log('Request payload:', JSON.stringify(requestData));
        
        // Get URL
        const url = "{% url 'employees:bulk_delete_public_holidays' %}";
        console.log('Request URL:', url);
        
        // Show loading state
        const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
        const originalText = bulkDeleteBtn.innerHTML;
        bulkDeleteBtn.disabled = true;
        bulkDeleteBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Deleting...';
        
        // Make fetch request
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': tokenValue
            },
            body: JSON.stringify(requestData)
        })
        .then(response => {
            console.log('=== RESPONSE RECEIVED ===');
            console.log('Status:', response.status);
            console.log('Status Text:', response.statusText);
            console.log('OK:', response.ok);
            
            // Try to parse JSON even if response is not ok
            return response.json().then(data => {
                return { data, status: response.status, ok: response.ok };
            });
        })
        .then(({ data, status, ok }) => {
            console.log('=== RESPONSE DATA ===');
            console.log('Data:', data);
            
            // Reset button state
            bulkDeleteBtn.disabled = false;
            bulkDeleteBtn.innerHTML = originalText;
            
            if (ok && data.success) {
                console.log('Success! Deleted count:', data.message);
                alert(data.message || 'Holidays deleted successfully!');
                window.location.reload();
            } else {
                console.error('Error response:', data);
                alert('Error: ' + (data.error || 'Unknown error occurred'));
            }
        })
        .catch(error => {
            console.error('=== FETCH ERROR ===');
            console.error('Error:', error);
            console.error('Error message:', error.message);
            console.error('Error stack:', error.stack);
            
            // Reset button state
            bulkDeleteBtn.disabled = false;
            bulkDeleteBtn.innerHTML = originalText;
            
            alert('Network error: ' + error.message + '\n\nPlease check:\n1. Your internet connection\n2. Browser console for details\n3. Django server is running');
        });
    }

    // Update row numbers after deletion
    function updateRowNumbers() {
        const visibleRows = document.querySelectorAll('tbody tr[style*="table-row"], tbody tr:not([style])');
        const counters = document.querySelectorAll('.holiday-counter');
        
        counters.forEach((counter, index) => {
            counter.textContent = index + 1;
        });
    }
</script>

<style>
    .country-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 10px;
    }

    .country-tab {
        background: transparent;
        border: none;
        padding: 10px 20px;
        border-radius: 8px 8px 0 0;
        cursor: pointer;
        font-weight: 500;
        color: #6c757d;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        border: 1px solid transparent;
    }

    .country-tab:hover {
        background: rgba(67, 49, 133, 0.05);
        color: var(--primary);
    }

    .country-tab.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
        box-shadow: 0 2px 8px rgba(67, 49, 133, 0.2);
    }

    .country-tab i {
        font-size: 1rem;
    }

    /* Country content visibility using class instead of inline styles */
    .country-content {
        display: none;
        animation: fadeIn 0.3s ease-in-out;
    }

    .country-content.active {
        display: block;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
{% endblock %}