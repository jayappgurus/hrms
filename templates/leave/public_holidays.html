{% extends 'base.html' %}

{% block title %}Public Holidays - HRMS Portal{% endblock %}

{% block page_title %}Public Holidays{% endblock %}

{% block content %}
<!-- Hidden CSRF token for JavaScript -->
{% csrf_token %}

<!-- Page Header -->
<div class="page-header">
    <div>
        <h1 class="page-title">
            <i class="bi bi-calendar-event text-primary"></i>
            Public Holidays
        </h1>
        <p class="page-subtitle">Manage company holidays and observances</p>
    </div>
    {% if user.is_superuser or user.is_staff %}
    <div class="d-flex gap-2">
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-file-earmark-spreadsheet me-2"></i>CSV
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="{% url 'employees:export_public_holidays_csv' %}">
                    <i class="bi bi-download me-2"></i>Export CSV
                </a></li>
                <li><a class="dropdown-item" href="{% url 'employees:import_public_holidays_csv' %}">
                    <i class="bi bi-upload me-2"></i>Import CSV
                </a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="{% url 'employees:download_public_holiday_sample_csv' %}">
                    <i class="bi bi-file-earmark-text me-2"></i>Download Sample
                </a></li>
            </ul>
        </div>
        <a href="{% url 'employees:public_holiday_add' %}" class="btn btn-primary">
            <i class="bi bi-plus-circle me-2"></i>Add Holiday
        </a>
    </div>
    {% endif %}
</div>

<!-- Holidays Table -->
<div class="modern-card">
    <div class="modern-card-header">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
            <h5 class="modern-card-title mb-0">
                <i class="bi bi-list-ul"></i>
                Upcoming Holidays
            </h5>
            <div class="filter-pills">
                <!-- <button class="filter-pill active" data-year="all">All Years</button> -->
                {% for year in available_years %}
                <button class="filter-pill {% if year == current_year %}active{% endif %}" data-year="{{ year }}">
                    {{ year }}</button>
                {% endfor %}
            </div>
        </div>
    </div>
    <div class="modern-card-body p-0">
        {% if holidays %}
        <div class="table-responsive">
            <table class="modern-table">
                <thead>
                    <tr>
                        <th>Holiday Name</th>
                        <th>Date</th>
                        <th>Day</th>
                        <th>Type</th>
                        {% if user.is_superuser or user.is_staff %}
                        <th class="text-end">Actions</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% for holiday in holidays %}
                    <tr data-year="{{ holiday.year }}">
                        <td data-label="Holiday Name">
                            <div class="d-flex align-items-center gap-3">
                                <div class="info-icon">
                                    <i class="bi bi-calendar-event"></i>
                                </div>
                                <div>
                                    <div class="fw-semibold">{{ holiday.name }}</div>
                                    {% if holiday.description %}
                                    <small class="text-muted">{{ holiday.description|truncatewords:10 }}</small>
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                        <td data-label="Date">
                            <span class="fw-medium">{{ holiday.date|date:"M d, Y" }}</span>
                        </td>
                        <td data-label="Day">
                            <span class="status-badge info">
                                {{ holiday.date|date:"l" }}
                            </span>
                        </td>
                        <td data-label="Type">
                            {% if holiday.is_optional %}
                            <span class="status-badge warning">
                                <i class="bi bi-star"></i> Optional
                            </span>
                            {% else %}
                            <span class="status-badge success">
                                <i class="bi bi-check-circle"></i> Mandatory
                            </span>
                            {% endif %}
                        </td>
                        {% if user.is_superuser or user.is_staff %}
                        <td data-label="Actions" class="text-end">
                            <div class="table-actions justify-content-end">
                                <a href="{% url 'employees:public_holiday_edit' holiday.pk %}" class="action-icon-btn"
                                    title="Edit">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                <a href="#" class="action-icon-btn danger"
                                    onclick="confirmDelete({{ holiday.pk }}); return false;" title="Delete">
                                    <i class="bi bi-trash"></i>
                                </a>
                            </div>
                        </td>
                        {% endif %}

                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Year filter functionality
    document.addEventListener('DOMContentLoaded', function () {
        const filterPills = document.querySelectorAll('.filter-pill[data-year]');
        const tableRows = document.querySelectorAll('tbody tr[data-year]');

        filterPills.forEach(pill => {
            pill.addEventListener('click', function () {
                filterPills.forEach(p => p.classList.remove('active'));
                this.classList.add('active');

                const year = this.dataset.year;

                tableRows.forEach(row => {
                    if (year === 'all' || row.dataset.year === year) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            });
        });

        // Initialize visibility based on the active pill
        const activePill = document.querySelector('.filter-pill.active');
        if (activePill) {
            const initialYear = activePill.dataset.year;
            tableRows.forEach(row => {
                if (initialYear === 'all' || row.dataset.year === initialYear) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
    });

    // Delete confirmation function
    function confirmDelete(holidayId) {
        if (confirm('Are you sure you want to delete this holiday? This action cannot be undone.')) {
            // Create a form and submit it
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/public-holidays/${holidayId}/delete/`;

            // Add CSRF token - try multiple methods
            let csrfToken = null;

            // Method 1: Look for hidden input with CSRF token
            const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
            if (csrfInput) {
                csrfToken = csrfInput.value;
            }

            // Method 2: Get from cookie (Django standard method)
            if (!csrfToken) {
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    const [name, value] = cookie.trim().split('=');
                    if (name === 'csrftoken') {
                        csrfToken = decodeURIComponent(value);
                        break;
                    }
                }
            }

            // Add CSRF token to form if found
            if (csrfToken) {
                const csrfField = document.createElement('input');
                csrfField.type = 'hidden';
                csrfField.name = 'csrfmiddlewaretoken';
                csrfField.value = csrfToken;
                form.appendChild(csrfField);
            }

            document.body.appendChild(form);
            form.submit();
        }
    }
</script>
{% endblock %}