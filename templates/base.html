{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}HRMS Portal{% endblock %}</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'css/hrms-portal.css' %}">
    <link rel="stylesheet" href="{% static 'css/shared-components.css' %}">
    <link rel="icon" type="image/svg+xml" href="{% static 'images/favicon.svg' %}">

    {% block extra_css %}{% endblock %}
</head>

<body>
    <!-- Preloader -->
    <div id="preloader">
        <div class="loader"></div>
    </div>

    <!-- Main Wrapper -->
    <div class="main-wrapper">

        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <div class="logo-placeholder">
                        <img src="{% static 'images/favicon.svg' %}" alt="HRMS Portal">
                    </div>
                    <h4 class="logo-title">HRMS Portal</h4>
                </div>
                <!-- Mobile Menu Overlay -->
                <div class="mobile-menu-overlay" id="mobileMenuOverlay"></div>
            </div>

            <div class="sidebar-body">
                <ul class="sidebar-nav p-0">
                    <li class="nav-label">Main</li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}"
                            href="{% url 'employees:dashboard' %}">
                            <i class="bi bi-speedometer2"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>

                    <li class="nav-label">Management</li>
                    <li class="nav-item">
                        <a class="nav-link {% if 'employee' in request.resolver_match.url_name %}active{% endif %}"
                            href="{% url 'employees:employee_list' %}">
                            <i class="bi bi-people"></i>
                            <span>Employees</span>
                        </a>
                    </li>

                    <li class="nav-item">
                        <a class="nav-link {% if 'device' in request.resolver_match.url_name %}active{% endif %}"
                            href="{% url 'employees:device_visibility' %}">
                            <i class="bi bi-laptop"></i>
                            <span>Devices</span>
                        </a>
                    </li>

                    <li class="nav-item">
                        <a class="nav-link {% if 'leave' in request.resolver_match.url_name or 'holiday' in request.resolver_match.url_name %}active{% endif %}"
                            href="{% url 'employees:public_holidays' %}">
                            <i class="bi bi-calendar-event"></i>
                            <span>Leaves & Holidays</span>
                            <i class="bi bi-chevron-down nav-arrow"></i>
                        </a>
                        <ul
                            class="sub-menu {% if 'leave' in request.resolver_match.url_name or 'holiday' in request.resolver_match.url_name %}show{% endif %}">
                            <li class="mt-2"><a href="{% url 'employees:leave_types' %}"
                                    class="{% if request.resolver_match.url_name == 'leave_types' %}active{% endif %}">Leave
                                    Types</a></li>
                            <li class="mt-2"><a href="{% url 'employees:leave_application_list' %}"
                                    class="{% if request.resolver_match.url_name == 'leave_application_list' %}active{% endif %}">Leave
                                    Applications</a></li>
                            <li class="has-submenu mt-2">
                                <a href="{% url 'employees:public_holidays' %}"
                                    class="d-flex justify-content-between align-items-center {% if request.resolver_match.url_name == 'public_holidays' or request.resolver_match.url_name == 'public_holidays_by_country' %}active{% endif %}">
                                    Public Holidays
                                    <i class="bi bi-chevron-down nav-arrow"></i>
                                </a>
                                <ul class="sub-submenu mt-2">
                                    <li><a href="{% url 'employees:public_holidays_by_country' 'indian' %}"
                                            class="{% if request.resolver_match.kwargs.country == 'indian' %}active{% endif %}">Indian
                                            Holidays</a></li>
                                    <li class="mt-2"><a href="{% url 'employees:public_holidays_by_country' 'australian' %}"
                                            class="{% if request.resolver_match.kwargs.country == 'australian' %}active{% endif %}">Australian
                                            Holidays</a></li>
                                </ul>
                            </li>
                        </ul>
                    </li>

                    <li class="nav-label">Recruitment</li>
                    <li class="nav-item">
                        <a class="nav-link {% if 'job' in request.resolver_match.url_name or 'candidate' in request.resolver_match.url_name %}active{% endif %}"
                            href="{% url 'employees:job_list' %}">
                            <i class="bi bi-briefcase"></i>
                            <span>Jobs & Hiring</span>
                            <i class="bi bi-chevron-down nav-arrow"></i>
                        </a>
                        <ul
                            class="sub-menu {% if 'job' in request.resolver_match.url_name or 'candidate' in request.resolver_match.url_name %}show{% endif %}">
                            <li class="mt-2"><a href="{% url 'employees:job_list' %}"
                                    class="{% if request.resolver_match.url_name == 'job_list' %}active{% endif %}">Job
                                    Descriptions</a></li>
                            <li class="mt-2"><a href="{% url 'employees:candidate_tracker' %}"
                                    class="{% if request.resolver_match.url_name == 'candidate_tracker' %}active{% endif %}">Candidate
                                    Tracker</a></li>
                            <li class="mt-2"><a href="{% url 'employees:current_openings' %}"
                                    class="{% if request.resolver_match.url_name == 'current_openings' %}active{% endif %}">Current
                                    Openings</a></li>
                        </ul>
                    </li>

                    {% if user.is_staff or user.is_superuser %}
                    <li class="nav-label">Communications</li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'create_notification' %}active{% endif %}"
                            href="{% url 'employees:create_notification' %}">
                            <i class="bi bi-bell"></i>
                            <span>Send Notification</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'create_message' %}active{% endif %}"
                            href="{% url 'employees:create_message' %}">
                            <i class="bi bi-envelope"></i>
                            <span>Send Message</span>
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </div>
        </div>

        <!-- Main Content -->
        <div class="page-wrapper">

            <!-- Top Header -->
            <header class="top-header">
                <!-- <div class="header-left">
                    <button class="mobile-sidebar-toggle" id="mobileSidebarToggle">
                        <i class="bi bi-list"></i>
                    </button>
                    <div class="search-bar">
                        <input type="text" class="form-control" placeholder="Search...">
                        <i class="bi bi-search"></i>
                    </div>
                </div> -->

                <div class="header-right">
                    <!-- Notifications -->
                    <div class="dropdown">
                        <button class="header-btn" type="button" data-bs-toggle="dropdown">
                            <i class="bi bi-bell"></i>
                            {% if unread_notifications_count > 0 %}
                            <span class="badge bg-danger">{{ unread_notifications_count }}</span>
                            {% endif %}
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end notification-dropdown">
                            <li class="dropdown-header">Notifications</li>
                            {% if unread_notifications %}
                                {% for notification in unread_notifications %}
                                <li><a class="dropdown-item" href="#">
                                        <div class="notification-item">
                                            <i class="bi {{ notification.icon }} text-{{ notification.notification_type }}"></i>
                                            <div class="notification-content">
                                                <p>{{ notification.title }}</p>
                                                <small>{{ notification.created_at|timesince }} ago</small>
                                            </div>
                                        </div>
                                    </a></li>
                                {% endfor %}
                            {% else %}
                                <li><a class="dropdown-item text-center text-muted">No new notifications</a></li>
                            {% endif %}
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item text-center" href="#">View all notifications</a></li>
                        </ul>
                    </div>

                    <!-- Messages -->
                    <div class="dropdown">
                        <button class="header-btn" type="button" data-bs-toggle="dropdown">
                            <i class="bi bi-envelope"></i>
                            {% if unread_messages_count > 0 %}
                            <span class="badge bg-danger">{{ unread_messages_count }}</span>
                            {% endif %}
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end message-dropdown">
                            <li class="dropdown-header">Messages</li>
                            {% if unread_messages %}
                                {% for message in unread_messages %}
                                <li><a class="dropdown-item" href="#">
                                        <div class="message-item">
                                            <div class="message-avatar">{{ message.sender.get_full_name|slice:":2"|upper|default:message.sender.username|slice:":2"|upper }}</div>
                                            <div class="message-content">
                                                <p>{{ message.sender.get_full_name|default:message.sender.username }}</p>
                                                <small>{{ message.subject|truncatewords:5 }}</small>
                                            </div>
                                        </div>
                                    </a></li>
                                {% endfor %}
                            {% else %}
                                <li><a class="dropdown-item text-center text-muted">No new messages</a></li>
                            {% endif %}
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item text-center" href="#">View all messages</a></li>
                        </ul>
                    </div>

                    <!-- User Profile -->
                    <div class="dropdown">
                        <button class="user-profile-btn" type="button" data-bs-toggle="dropdown">
                            <div class="user-avatar">
                                {% if user.profile.employee.profile_picture %}
                                    <img src="{{ user.profile.employee.profile_picture.url }}" alt="{{ user.get_full_name }}" style="width: 40px; height: 40px; object-fit: cover; border-radius: 50%;">
                                {% else %}
                                    <div class="avatar-placeholder">
                                        <i class="bi bi-person"></i>
                                    </div>
                                {% endif %}
                            </div>
                            <div class="user-info">
                                <span class="user-name">{{ user.get_full_name|default:user.username|title }}</span>
                                <span class="user-role">
                                    {% if user.profile %}
                                    {{ user.profile.get_role_display }}
                                    {% else %}
                                    Employee
                                    {% endif %}
                                </span>
                            </div>
                            <i class="bi bi-chevron-down"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li>
                                <a class="dropdown-item" href="{% url 'employees:my_profile' %}">
                                    <i class="bi bi-person me-2"></i>Profile
                                </a>
                            </li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item text-danger" href="{% url 'logout' %}">
                                    <i class="bi bi-box-arrow-right me-2"></i>Logout
                                </a></li>
                        </ul>
                    </div>
                </div>
            </header>

            <!-- Page Content -->
            <main class="main-content">
                <!-- Page Header -->
                {% if request.resolver_match.url_name == 'dashboard' %}
                <div class="page-header">
                    <div class="page-title w-100 justify-content-between">
                        <h2>{% block page_title %}Dashboard{% endblock %}</h2>
                        <!-- <nav aria-label="breadcrumb">
                            <ol class="breadcrumb">
                                <li class="breadcrumb-item"><a href="{% url 'employees:dashboard' %}">Home</a></li>
                                {% block breadcrumb %}{% endblock %}
                            </ol>
                        </nav> -->
                    </div>

                    {% block page_actions %}{% endblock %}
                </div>
                {% endif %}
                {% block content %}{% endblock %}
            </main>
        </div>
    </div>

    <!-- Modern Alert/Confirm Modal -->
    <div class="modern-modal" id="modernAlertModal">
        <div class="modern-modal-backdrop"></div>
        <div class="modern-modal-dialog">
            <div class="modern-modal-content">
                <div class="modern-modal-header">
                    <div class="modern-modal-icon" id="modalIcon">
                        <i class="bi bi-info-circle"></i>
                    </div>
                    <h5 class="modern-modal-title" id="modalTitle">Confirm Action</h5>
                </div>
                <div class="modern-modal-body">
                    <p id="modalMessage">Are you sure you want to proceed?</p>
                </div>
                <div class="modern-modal-footer">
                    <button type="button" class="btn btn-secondary modern-btn-secondary" id="modalCancel">Cancel</button>
                    <button type="button" class="btn btn-primary modern-btn-primary" id="modalConfirm">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <!-- Custom JavaScript -->
    <script>
        // Hide preloader when page loads
        window.addEventListener('load', function () {
            document.getElementById('preloader').style.display = 'none';
        });

        // Modern Alert/Confirm System
        class ModernAlert {
            constructor() {
                this.modal = document.getElementById('modernAlertModal');
                this.title = document.getElementById('modalTitle');
                this.message = document.getElementById('modalMessage');
                this.icon = document.getElementById('modalIcon');
                this.confirmBtn = document.getElementById('modalConfirm');
                this.cancelBtn = document.getElementById('modalCancel');
                this.currentResolve = null;
                
                this.initEventListeners();
            }

            initEventListeners() {
                this.confirmBtn.addEventListener('click', () => this.handleConfirm());
                this.cancelBtn.addEventListener('click', () => this.handleCancel());
                
                // Close on backdrop click
                this.modal.querySelector('.modern-modal-backdrop').addEventListener('click', () => {
                    this.handleCancel();
                });
                
                // Close on Escape key
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && this.modal.classList.contains('show')) {
                        this.handleCancel();
                    }
                });
            }

            show(options = {}) {
                const {
                    type = 'info',
                    title = 'Confirm Action',
                    message = 'Are you sure you want to proceed?',
                    confirmText = 'Confirm',
                    cancelText = 'Cancel',
                    showCancel = true
                } = options;

                // Set content
                this.title.textContent = title;
                this.message.textContent = message;
                this.confirmBtn.textContent = confirmText;
                this.cancelBtn.textContent = cancelText;

                // Set icon and colors based on type
                this.setIcon(type);

                // Show/hide cancel button
                this.cancelBtn.style.display = showCancel ? 'inline-block' : 'none';

                // Show modal
                this.modal.classList.add('show');
                document.body.style.overflow = 'hidden';

                // Return promise
                return new Promise((resolve) => {
                    this.currentResolve = resolve;
                });
            }

            setIcon(type) {
                const iconClasses = {
                    info: 'bi-info-circle text-info',
                    success: 'bi-check-circle text-success',
                    warning: 'bi-exclamation-triangle text-warning',
                    danger: 'bi-x-circle text-danger',
                    question: 'bi-question-circle text-primary'
                };

                this.icon.className = 'modern-modal-icon';
                this.icon.innerHTML = `<i class="bi ${iconClasses[type] || iconClasses.info}"></i>`;

                // Update button colors
                this.confirmBtn.className = `btn modern-btn-primary ${type === 'danger' ? 'btn-danger' : type === 'success' ? 'btn-success' : 'btn-primary'}`;
            }

            handleConfirm() {
                this.hide();
                if (this.currentResolve) {
                    this.currentResolve(true);
                }
            }

            handleCancel() {
                this.hide();
                if (this.currentResolve) {
                    this.currentResolve(false);
                }
            }

            hide() {
                this.modal.classList.remove('show');
                document.body.style.overflow = '';
                this.currentResolve = null;
            }
        }

        // Global alert functions
        window.modernAlert = new ModernAlert();

        // Replace native confirm
        window.confirm = function(message, title = 'Confirm Action') {
            return window.modernAlert.show({
                type: 'question',
                title: title,
                message: message,
                confirmText: 'Yes',
                cancelText: 'No'
            });
        };

        // Replace native alert
        window.alert = function(message, title = 'Information', type = 'info') {
            return window.modernAlert.show({
                type: type,
                title: title,
                message: message,
                confirmText: 'OK',
                showCancel: false
            });
        };

        // Convenience methods
        window.showSuccess = function(message, title = 'Success') {
            return window.alert(message, title, 'success');
        };

        window.showError = function(message, title = 'Error') {
            return window.alert(message, title, 'danger');
        };

        window.showWarning = function(message, title = 'Warning') {
            return window.alert(message, title, 'warning');
        };

        window.showInfo = function(message, title = 'Information') {
            return window.alert(message, title, 'info');
        };

        // Sidebar toggle functionality
        document.getElementById('sidebarToggle')?.addEventListener('click', function () {
            document.getElementById('sidebar').classList.toggle('collapsed');
        });

        document.getElementById('mobileSidebarToggle')?.addEventListener('click', function () {
            document.getElementById('sidebar').classList.toggle('mobile-open');
        });

        // Submenu toggle
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', function (e) {
                const submenu = this.nextElementSibling;
                if (submenu && submenu.classList.contains('sub-menu')) {
                    e.preventDefault();

                    // Close other submenus
                    document.querySelectorAll('.sub-menu').forEach(menu => {
                        if (menu !== submenu) {
                            menu.classList.remove('show');
                        }
                    });

                    // Toggle current submenu
                    this.classList.toggle('active');
                    submenu.classList.toggle('show');
                }
            });
        });

        // Sub-submenu toggle
        document.querySelectorAll('.sub-menu .has-submenu > a').forEach(link => {
            link.addEventListener('click', function (e) {
                e.preventDefault();
                e.stopPropagation();
                
                const subSubmenu = this.nextElementSibling;
                if (subSubmenu && subSubmenu.classList.contains('sub-submenu')) {
                    // Toggle sub-submenu
                    subSubmenu.classList.toggle('show');
                    
                    // Toggle expanded class on parent li
                    const parentLi = this.closest('.has-submenu');
                    if (parentLi) {
                        parentLi.classList.toggle('expanded', subSubmenu.classList.contains('show'));
                    }
                }
            });
        });

        // Set initial active states based on current URL
        const currentPath = window.location.pathname;
        document.querySelectorAll('.nav-link').forEach(link => {
            const submenu = link.nextElementSibling;
            if (submenu && submenu.classList.contains('sub-menu')) {
                const links = submenu.querySelectorAll('a');
                let hasActiveChild = false;

                links.forEach(subLink => {
                    if (subLink.getAttribute('href') === currentPath) {
                        hasActiveChild = true;
                        
                        // Check if it's in a sub-submenu
                        const subSubmenu = subLink.closest('.sub-submenu');
                        if (subSubmenu) {
                            subSubmenu.classList.add('show');
                            const parentLi = subSubmenu.closest('.has-submenu');
                            if (parentLi) {
                                parentLi.classList.add('expanded');
                            }
                        }
                    }
                });

                if (hasActiveChild) {
                    link.classList.add('active');
                    submenu.classList.add('show');
                }
            }
        });

        // Close mobile sidebar when clicking outside
        document.addEventListener('click', function (e) {
            const sidebar = document.getElementById('sidebar');
            const toggle = document.getElementById('mobileSidebarToggle');

            if (!sidebar.contains(e.target) && !toggle.contains(e.target)) {
                sidebar.classList.remove('mobile-open');
            }
        });
    </script>

    {% block extra_js %}
    <script>
        // Enhanced Mobile Sidebar & Overlay Logic
        document.addEventListener('DOMContentLoaded', function () {
            const mobileToggle = document.getElementById('mobileSidebarToggle');
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobileMenuOverlay');

            function searchToggle() {
                // Implement if search needed on mobile
            }

            function toggleSidebar() {
                if (window.innerWidth <= 991) {
                    sidebar.classList.toggle('mobile-open');
                    if (overlay) {
                        overlay.classList.toggle('show');
                    }
                } else {
                    sidebar.classList.toggle('collapsed');
                }
            }

            function closeSidebar() {
                sidebar.classList.remove('mobile-open');
                if (overlay) {
                    overlay.classList.remove('show');
                }
            }

            // Bind Events
            if (mobileToggle) {
                mobileToggle.addEventListener('click', function (e) {
                    e.stopPropagation();
                    toggleSidebar();
                });
            }

            if (overlay) {
                overlay.addEventListener('click', closeSidebar);
            }

            // Close on Escape key
            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape') {
                    closeSidebar();
                }
            });

            // Handle resize
            let resizeTimer;
            window.addEventListener('resize', function () {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(function () {
                    if (window.innerWidth > 991) {
                        closeSidebar();
                    }
                }, 250);
            });
        });
    </script>
    {% endblock %}
</body>

</html>